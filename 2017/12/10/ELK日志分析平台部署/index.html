<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>elk日志分析平台部署 | Gary Wu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="高级运维ELKelasticsearchkibanalogstashkopfELK安全设置elasticsearch集群监控" />
  
  
  
  
  <meta name="description" content="什么是ELK？ELK 是由Elasticsearch、Logstash、Kibana 三个开源软件的组成的一个组合体。  官方网站: https://www.elastic.co/">
<meta name="keywords" content="高级运维,ELK,elasticsearch,kibana,logstash,kopf,ELK安全设置,elasticsearch集群监控">
<meta property="og:type" content="article">
<meta property="og:title" content="ELK日志分析平台部署">
<meta property="og:url" content="https://wuyanteng.github.io/2017/12/10/ELK日志分析平台部署/index.html">
<meta property="og:site_name" content="Gary Wu">
<meta property="og:description" content="什么是ELK？ELK 是由Elasticsearch、Logstash、Kibana 三个开源软件的组成的一个组合体。  官方网站: https://www.elastic.co/">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es-head.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es-input_data.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es%E7%B4%A2%E5%BC%95%E9%AA%8C%E8%AF%81.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/logstash%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/kibana_status.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es_log.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/kibana_pattern.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/kibana_discover.png">
<meta property="og:updated_time" content="2018-02-04T08:24:09.242Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ELK日志分析平台部署">
<meta name="twitter:description" content="什么是ELK？ELK 是由Elasticsearch、Logstash、Kibana 三个开源软件的组成的一个组合体。  官方网站: https://www.elastic.co/">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es-head.png">
  
    <link rel="alternate" href="/atom.xml" title="Gary Wu" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpg">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-ELK日志分析平台部署" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      ELK日志分析平台部署
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/12/10/ELK日志分析平台部署/" class="article-date">
	  <time datetime="2017-12-10T01:40:22.000Z" itemprop="datePublished">2017-12-10</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="什么是ELK？"><a href="#什么是ELK？" class="headerlink" title="什么是ELK？"></a>什么是ELK？</h4><pre><code>ELK 是由Elasticsearch、Logstash、Kibana 三个开源软件的组成的一个组合体。

官方网站: https://www.elastic.co/
</code></pre><a id="more"></a>
<pre><code>Elasticsearch 是一个高度可扩展的开源全文搜索和分析引擎，它可实现数据的实时全文搜索、支持分布式可实现高可用、提供API 接口，可以处理大规模日志数据，比如Nginx、Tomcat、系统日志等功能。

Logstash 可以通过插件实现日志收集和转发，支持日志过滤，支持普通log、自定义json格式的日志解析。

kibana：主要是通过接口调用elasticsearch 的数据，并进行前端数据可视化的展现。
</code></pre><!-- more -->
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h4 id="Elasticsearch集群部署"><a href="#Elasticsearch集群部署" class="headerlink" title="Elasticsearch集群部署"></a>Elasticsearch集群部署</h4><blockquote>
<p>环境初始化</p>
</blockquote>
<pre><code>1. 为保证效果特额外添加一块单独的数据磁盘大小为50G 并格式化挂载到/elk
   mkdir /elk &amp;&amp; mkfs.ext4 /dev/sdb
   blkid /dev/sdb

2. 关闭防所有服务器的火墙和selinux。是为了避免出现各种未知问题
3. 修改limit限制
   echo &quot;* soft nofile 65536&quot; &gt;&gt; /etc/security/limits.conf
   echo &quot;* hard nofile 65536&quot; &gt;&gt; /etc/security/limits.conf
4. 各服务器配置本地域名解析
   10.0.10.21   host21.exmaple.com
   10.0.10.22   host22.exmaple.com
   10.0.10.23   host23.exmaple.com
5. 设置epel源、安装基本操作命令并同步时间 
   wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
   cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
   echo &quot;*/5 * * * * ntpdate -u time1.aliyun.com &gt;/dev/null 2&gt;&amp;1 &quot; &gt;&gt;/var/spool/cron/root

重启系统，没有问题的话给虚拟机做快照以方便后期还原   
</code></pre><blockquote>
<p>安装Elasticsearch</p>
</blockquote>
<ul>
<li>安装java环境</li>
</ul>
<pre><code>http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html
接受协议并下载&quot;jdk-8u151-linux-x64.tar.gz&quot;
</code></pre><pre><code>tar xvf jdk-8u121-linux-x64.tar.gz -C /usr/local/
ln -sv /usr/local/jdk1.8.0_121 /usr/local/jdk

cat &gt;&gt; /etc/profile &lt;&lt;EOF
export HISTTIMEFORMAT=&quot;%F %T `whoami` &quot;     
export JAVA_HOME=/usr/local/jdk
export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
export PATH=$PATH:$JAVA_HOME/bin
EOF

注：export HISTTIMEFORMAT=&quot;%F %T `whoami` &quot; 是给history加上时间戳


source /etc/profile

[root@linux~]# java -version
java version &quot;1.8.0_121&quot;   #确认可以出现当前的java 版本号
Java(TM) SE Runtime Environment (build 1.8.0_121-b13)
Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)
</code></pre><ul>
<li>安装Elasticsearch</li>
</ul>
<pre><code>目前稳定版本为5.6.5,建议使用此版本用于生产环境
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.5.rpm
yum install -y elasticsearch-5.6.5.rpm
</code></pre><ul>
<li>编辑各elasticsearch服务器节点的配置文件</li>
</ul>
<pre><code>[root@linux-host1 ~]# grep &quot;^[a-Z]&quot; /etc/elasticsearch/elasticsearch.yml
cluster.name: ELK-Cluster         #ELK集群名称，名称相同即属于是同一个集群
node.name: elk-node1              #本机在集群内的节点名称,其他为elk-node2、elk-node3...
path.data: /elk/data              #数据保存目录
path.logs: /elk/logs              #日志保存目
bootstrap.memory_lock: true       #服务启动的时候锁定足够的内存，防止数据写入swap
network.host: 0.0.0.0             #监听IP
http.port: 9200
discovery.zen.ping.unicast.hosts: [&quot;10.0.10.21&quot;, &quot;10.0.10.22&quot;, &quot;10.0.10.23&quot;]
</code></pre><ul>
<li>修改各节点内存限制</li>
</ul>
<pre><code>修改elasticsearch的启动文件脚本
vim /usr/lib/systemd/system/elasticsearch.service
搜索“LimitNOFILE=65536”  在这个位置，添加如下参数：
LimitMEMLOCK=infinity      ##此参数,可以最大化使用内存


[root@host21 ~]# grep &quot;^[-]&quot; /etc/elasticsearch/jvm.options    #修改最小和最大内存
-Xms4g
-Xmx4g
注：此处内存设置不能等于物理内存，否则进程启动后会立即自杀
注：官方建议此处最大内存配置为30G ；
为什么最大和最小内存配置为一样大？参考官方说明：
https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html
</code></pre><ul>
<li>目录权限更改</li>
</ul>
<pre><code>修改各节点中用于存放elasticsearch数据和日志目录的权限为elasticsearch
id  elasticsearch
mkdir -p /elk/{data,logs}
chown -R elasticsearch:elasticsearch /elk
ll /elk
</code></pre><ul>
<li>启动各节点elasticsearch服务并验证</li>
</ul>
<pre><code>systemctl start elasticsearch
systemctl status elasticsearch
systemctl enable elasticsearch

[root@host23 ~]# ss -lntup |grep 9200
tcp    LISTEN     0      128      :::9200   :::*    users:((&quot;java&quot;,pid=19034,fd=223))
</code></pre><ul>
<li>通过浏览器访问各节点的elasticsearch服务端口</li>
</ul>
<pre><code>http://10.0.10.21:9200
http://10.0.10.22:9200
http://10.0.10.23:9200
</code></pre><pre><code>访问http://10.0.10.21:9200结果如下：

{
  &quot;name&quot; : &quot;elk-node1&quot;,             #本节点名称
  &quot;cluster_name&quot; : &quot;ELK-Cluster&quot;,   #集群名称
  &quot;cluster_uuid&quot; : &quot;8GbwHyOFRQ-FtF785a0HPQ&quot;,   
  &quot;version&quot; : {
    &quot;number&quot; : &quot;5.6.5&quot;,             #elasticsearch版本号
    &quot;build_hash&quot; : &quot;6a37571&quot;,
    &quot;build_date&quot; : &quot;2017-12-04T07:50:10.466Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;6.6.1&quot;      #lucene版本号,elasticsearch基于Lucene做搜索
  },
  &quot;tagline&quot; : &quot;You Know, for Search&quot;  #口号
}
</code></pre><!-- more -->
<blockquote>
<p>安装elasticsearch插件之head(其中一个节点安装即可)</p>
</blockquote>
<ul>
<li>安装es5.x版本的elasticsearch-head插件</li>
</ul>
<pre><code>在elasticsearch 5.x 版本以后不再支持直接安装head 插件，而是需要通过启动npm方式安装
git地址：https://github.com/mobz/elasticsearch-head

yum install -y npm

cd /usr/local/src/ &amp;&amp; git clone git://github.com/mobz/elasticsearch-head.git
cd elasticsearch-head/ &amp;&amp; yum install -y openssl openssl-devel
npm install grunt -save
ll node_modules/grunt      #确认生成文件
npm install                #执行安装
npm run start &amp;            #后台启动服务
</code></pre><ul>
<li>修改各节点elasticsearch服务配置文件【每个es节点都要修改】</li>
</ul>
<pre><code>开启跨域访问支持，然后重启elasticsearch 服务：

vim /etc/elasticsearch/elasticsearch.yml    #最下方添加以下两行
http.cors.enabled: true 
http.cors.allow-origin: &quot;*&quot;

systemctl  restart elasticsearch
</code></pre><ul>
<li>web访问elasticsearch-head</li>
</ul>
<pre><code>http://10.0.10.21:9100
</code></pre><p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es-head.png" alt="es-head"></p>
<ul>
<li>测试提交数据</li>
</ul>
<p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es-input_data.png" alt="es-input-data"></p>
<ul>
<li>验证索引是否存在</li>
</ul>
<p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es%E7%B4%A2%E5%BC%95%E9%AA%8C%E8%AF%81.png" alt="es验证索引"></p>
<ul>
<li>查看数据</li>
</ul>
<p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE.png" alt="es查看数据"></p>
<ul>
<li>Master与Slave的区别</li>
</ul>
<pre><code>Master 的职责：统计各node节点状态信息、集群状态信息统计、索引的创建和删除、索引分配的管理、关闭node节点等
Slave 的职责：同步数据、等待机会成为Master
</code></pre><!-- more -->
<blockquote>
<p>elasticsearch 插件之kopf</p>
</blockquote>
<pre><code>Git项目地址: https://github.com/lmenezes/elasticsearch-kopf

但是目前还不支持5.x版本的elasticsearch，但是可以安装在elasticsearc 1.x 或2.x 的版本安装。
</code></pre><blockquote>
<p>elasticsearch集群监控</p>
</blockquote>
<pre><code>[root@host21 ~]# curl -sXGET http://10.0.10.21:9200/_cluster/health?pretty=true
{
  &quot;cluster_name&quot; : &quot;ELK-Cluster&quot;,
  &quot;status&quot; : &quot;green&quot;,
  &quot;timed_out&quot; : false,
  &quot;number_of_nodes&quot; : 3,
  &quot;number_of_data_nodes&quot; : 3,
  &quot;active_primary_shards&quot; : 5,
  &quot;active_shards&quot; : 10,
  &quot;relocating_shards&quot; : 0,
  &quot;initializing_shards&quot; : 0,
  &quot;unassigned_shards&quot; : 0,
  &quot;delayed_unassigned_shards&quot; : 0,
  &quot;number_of_pending_tasks&quot; : 0,
  &quot;number_of_in_flight_fetch&quot; : 0,
  &quot;task_max_waiting_in_queue_millis&quot; : 0,
  &quot;active_shards_percent_as_number&quot; : 100.0
}

#获取到的是一个json 格式的返回值，那就可以通过python对其中的信息进行分
析，例如对status进行分析，如果等于green(绿色)就是运行在正常，等于yellow(黄色)表示副本分片丢失，red(红色)表示主分片丢失
</code></pre><p>python检测脚本</p>
<pre><code>[root@linux ~]# cat els-cluster-monitor.py
#!/usr/bin/env python
#coding:utf-8
#Author Zhang Jie
import smtplib
from email.mime.text import MIMEText
from email.utils import formataddr
import subprocess
body = &quot;&quot;
false=&quot;false&quot;
obj = subprocess.Popen((&quot;curl -sXGET http://10.0.10.21:9200/_cluster/healthpretty=true&quot;),shell=True,stdout=subprocess.PIPE)
data = obj.stdout.read()
data1 = eval(data)
status = data1.get(&quot;status&quot;)
if status == &quot;green&quot;:
print &quot;50&quot;
else:
print &quot;100&quot;
</code></pre><pre><code>脚本执行结果：
[root@linux-host1 ~]# python els-cluster-monitor.py
50
</code></pre><blockquote>
<p>排错</p>
</blockquote>
<pre><code>如果服务无法启动或启动立即停止，查看/var/log/message最新日志或ELK的logs目录
</code></pre><!-- more -->
<h4 id="部署Logstash"><a href="#部署Logstash" class="headerlink" title="部署Logstash"></a>部署Logstash</h4><pre><code>Logstash 是一个开源的数据收集引擎，可以水平伸缩，而且logstash 整个ELK
当中拥有最多插件的一个组件，其可以接收来自不同来源的数据并统一输出到指
定的且可以是多个不同目的地。

注：生产环境Logstash尽量与elasticsearch服务器分开，因为都是java程序，太浪费内存
</code></pre><blockquote>
<p>logstash工作流程图</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/logstash%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="logstash"></p>
<blockquote>
<p>环境准备</p>
</blockquote>
<pre><code>服务器：
10.0.10.24
10.0.10.25

关闭防火墙和selinux
更新时间：
cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
ntpdate -u ntp1.aliyun.com

systemctl stop firewalld
systemctl disable firewalld
sed -i &#39;/SELINUX/s/enforcing/disabled/&#39; /etc/selinux/config

安装java 环境: 同es初始化java安装
</code></pre><blockquote>
<p>安装logstash</p>
</blockquote>
<pre><code>官网：https://www.elastic.co/downloads/past-releases/logstash-5-6-5
同样是下载5.6.5版本

wget https://artifacts.elastic.co/downloads/logstash/logstash-5.6.5.rpm
yum install -y logstash-5.6.5.rpm
</code></pre><pre><code>#启动
systemctl start logstash
systemctl status logstash
systemctl enable logstash

注：rpm包方式安装，如果启动失败(提示无启动文件),依次执行如下命令
rpm -e logstash
rpm -ivh logstash-5.4.1.rpm
systemctl start logstash
</code></pre><ul>
<li>Logstash测试语法</li>
</ul>
<pre><code>logstash -f /etc/logstash/conf.d/systemlog.conf -t
Configuration OK
</code></pre><blockquote>
<p>测试logstash</p>
</blockquote>
<ul>
<li>测试标准输入</li>
</ul>
<pre><code>[root@localhost ~]# logstash -e &#39;input { stdin{} }
output { stdout{ codec =&gt; rubydebug }}&#39;
Hello Logstash !           #标准输入和输出


{
      &quot;@version&quot; =&gt; &quot;1&quot;,     #事件版本号，一个事件就是一个ruby对象
          &quot;host&quot; =&gt; &quot;localhost.localdomain&quot;,   #标记事件发生在哪里
    &quot;@timestamp&quot; =&gt; 2017-12-12T10:05:13.600Z,     #当前事件的发生时间
       &quot;message&quot; =&gt; &quot;Hello Logstash !&quot;     #消息的具体内容（就是我刚才输入的）
}
</code></pre><ul>
<li>测试输出到文件</li>
</ul>
<pre><code>logstash -e &#39;input { stdin{} }  output { file { path =&gt; &quot;/tmp/log-%{+YYYY.MM.dd}messages.gz&quot;}}&#39;
</code></pre><pre><code>[root@localhost ~]# tailf /tmp/log-2017.12.12messages.gz   #打开文件验证
{&quot;@version&quot;:&quot;1&quot;,&quot;host&quot;:&quot;localhost.localdomain&quot;,&quot;@timestamp&quot;:&quot;2017-12-12T10:12:17.087Z&quot;,&quot;message&quot;:&quot;Test&quot;}     
</code></pre><ul>
<li>测试输出到elasticsearch</li>
</ul>
<pre><code>logstash -e &#39;input { stdin{} } output { elasticsearch {hosts =&gt; [&quot;10.0.10.21:9200&quot;] index =&gt;&quot;mytest-%{+YYYY.MM.dd}&quot; }}&#39;
</code></pre><pre><code>elasticsearch 服务器验证收到数据：
[root@host21 ~]# ll /elk/data/nodes/0/indices/
total 8
drwxr-xr-x 6 elasticsearch elasticsearch 4096 Dec 12 05:18 thwe1ENcR-ed2zZe7FncDA
drwxr-xr-x 6 elasticsearch elasticsearch 4096 Dec 11 08:00 _x7SPg0MSdCC-sDJ43gRVQ
</code></pre><!-- more -->
<h4 id="部署kibana"><a href="#部署kibana" class="headerlink" title="部署kibana"></a>部署kibana</h4><pre><code>kibana：主要是通过接口调用elasticsearch 的数据，并进行前端数据可视化的展现。
</code></pre><ul>
<li>安装kibana到10.0.10.21服务器</li>
</ul>
<pre><code>官方下载：
wget https://artifacts.elastic.co/downloads/kibana/kibana-5.6.5-x86_64.rpm
yum install -y kibana-5.6.5-x86_64.rpm
</code></pre><ul>
<li>配置kibana</li>
</ul>
<pre><code>[root@host21 ~]# grep -n &quot;^[a-Z]&quot; /etc/kibana/kibana.yml
server.port: 5601      #监听端口
server.host: &quot;0.0.0.0&quot; #监听地址
elasticsearch.url: http://192.168.56.11:9200  #elasticsearch服务器地址
</code></pre><ul>
<li>启动kibana服务</li>
</ul>
<pre><code>systemctl start kibana
systemctl status kibana
systemctl enable kibana
[root@host21 ~]# ss -lntup |grep 5601
tcp    LISTEN     0      128       *:5601     *:*     users:((&quot;node&quot;,pid=3158,fd=11))
</code></pre><ul>
<li>验证</li>
</ul>
<pre><code>http://10.0.10.21:5601
</code></pre><p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/kibana_status.png" alt="kibana_status"></p>
<ul>
<li>kibana新建索引</li>
</ul>
<pre><code>访问elasticsearch-head插件：http://10.0.10.21:9100，查看elasticsearch已有的日志
</code></pre><p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/es_log.png" alt="es_log"></p>
<pre><code>然后，登陆kibana -- Management -- Index Patterns
</code></pre><p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/kibana_pattern.png" alt="kibana_pattern"></p>
<p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/kibana_discover.png" alt="kibana_discover"></p>
<p>由于日志并没有持续输出，所以此处显示为空，接下来将对logstash日志输出做详细说明，基本部署完成。</p>
<!-- more -->
<h4 id="nginx反向代理kibana"><a href="#nginx反向代理kibana" class="headerlink" title="nginx反向代理kibana"></a>nginx反向代理kibana</h4><blockquote>
<p>安全部署说明</p>
</blockquote>
<pre><code>通过nginx和kibana监听127.0.0.1以及在kibana客户端绑定hosts来实现安全

测试环境：10.0.10.21服务器
</code></pre><pre><code>yum install gcc gcc++ pcre openssl openssl-devel  zlib zlib-devel pcre-devel
./configure  --prefix=/usr/local/nginx --with-http_sub_module --with-http_ssl_module &amp;&amp; make &amp;&amp; make install
</code></pre><p>配置nginx代理kibana</p>
<pre><code>vim /etc/kibana/kibana.yml
server.host: &quot;127.0.0.1&quot;    #只监听127.0.0.1

systemctl restart kibana

mkdir  /usr/local/nginx/conf/conf.d/


nginx配置文件添加一行：
include /usr/local/nginx/conf/conf.d/*.conf;



vim /usr/local/nginx/conf/conf.d/kibana5612.conf   #添加如下配置
upstream kibana_server {
        server  127.0.0.1:5601 weight=1 max_fails=3  fail_timeout=60;
}

server {
        listen 80;
        server_name www.kibana1021.com;
        location / {
        proxy_pass http://kibana_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection &#39;upgrade&#39;;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        }
}

启动Nginx
/usr/local/nginx/sbin/nginx 
</code></pre><pre><code>yum install -y httpd-tools
htpasswd -bc htpasswd.txt garywu 123456   #文件路径需在/usr/local/nginx下
</code></pre><p>修改nginx kibana配置</p>
<pre><code>upstream kibana_server {
        #nginx也改为127.0.0.1 
        server  127.0.0.1:5601 weight=1 max_fails=3  fail_timeout=60;    
}

server {
        listen 80;
        server_name www.kibana1021.com;
        auth_basic &quot;Restricted Access&quot;;
        auth_basic_user_file /usr/local/nginx/htpasswd.txt;   #文件名千万别错了
        location / {
        proxy_pass http://kibana_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection &#39;upgrade&#39;;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        }
}
</code></pre><pre><code>windows添加本地解析：  10.0.10.21  www.kibana5612.com

重启kibana和nginx
web访问：http://www.kibana1021.com/    出现账号密码界面了
</code></pre>
      
    </div>
    <footer class="article-footer">
      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK/">ELK</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK安全设置/">ELK安全设置</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elasticsearch/">elasticsearch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elasticsearch集群监控/">elasticsearch集群监控</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kibana/">kibana</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kopf/">kopf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/logstash/">logstash</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/高级运维/">高级运维</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/12/12/通过Logstash收集日志/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          通过Logstash收集日志
        
      </div>
    </a>
  
  
    <a href="/2017/12/09/shell高级编程-进阶3/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">shell高级编程-进阶3</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是ELK？"><span class="nav-number">1.</span> <span class="nav-text">什么是ELK？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署"><span class="nav-number"></span> <span class="nav-text">部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Elasticsearch集群部署"><span class="nav-number">1.</span> <span class="nav-text">Elasticsearch集群部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#部署Logstash"><span class="nav-number">2.</span> <span class="nav-text">部署Logstash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#部署kibana"><span class="nav-number">3.</span> <span class="nav-text">部署kibana</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx反向代理kibana"><span class="nav-number">4.</span> <span class="nav-text">nginx反向代理kibana</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2018 Gary Wu All Rights Reserved.</p>
	      
	      
  		   	<p id="copyRightCn">Gary Wu 保留所有权利</p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>




  <script src="/js/dialog.js"></script>














  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Gary Wu
          </div>
          <div class="panel-body">
            Copyright © 2018 Gary Wu All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>