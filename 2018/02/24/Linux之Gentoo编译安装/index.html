<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>linux之gentoo编译安装 | Gary Wu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="高级运维LinuxGentooKernel内核编译" />
  
  
  
  
  <meta name="description" content="前段时间搞过一次Gentoo，最终以失败告终,新年开工正好有时间卷土重来。  配置过程相当复杂，需要很强的耐心，但整个过程下来后，会学到很多东西。 官方文档: Gentoo AMD64手册">
<meta name="keywords" content="高级运维,Linux,Gentoo,Kernel,内核编译">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux之Gentoo编译安装">
<meta property="og:url" content="https://wuyanteng.github.io/2018/02/24/Linux之Gentoo编译安装/index.html">
<meta property="og:site_name" content="Gary Wu">
<meta property="og:description" content="前段时间搞过一次Gentoo，最终以失败告终,新年开工正好有时间卷土重来。  配置过程相当复杂，需要很强的耐心，但整个过程下来后，会学到很多东西。 官方文档: Gentoo AMD64手册">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-02-27T10:50:25.002Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux之Gentoo编译安装">
<meta name="twitter:description" content="前段时间搞过一次Gentoo，最终以失败告终,新年开工正好有时间卷土重来。  配置过程相当复杂，需要很强的耐心，但整个过程下来后，会学到很多东西。 官方文档: Gentoo AMD64手册">
  
    <link rel="alternate" href="/atom.xml" title="Gary Wu" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpg">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-Linux之Gentoo编译安装" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      Linux之Gentoo编译安装
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/02/24/Linux之Gentoo编译安装/" class="article-date">
	  <time datetime="2018-02-24T08:53:57.000Z" itemprop="datePublished">2018-02-24</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <pre><code>前段时间搞过一次Gentoo，最终以失败告终,新年开工正好有时间卷土重来。

配置过程相当复杂，需要很强的耐心，但整个过程下来后，会学到很多东西。
</code></pre><p>官方文档: <a href="https://wiki.gentoo.org/wiki/Handbook:AMD64" target="_blank" rel="noopener">Gentoo AMD64手册</a></p>
<a id="more"></a>
<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><h5 id="下载minimal镜像"><a href="#下载minimal镜像" class="headerlink" title="下载minimal镜像"></a>下载minimal镜像</h5><pre><code>官方镜像地址：http://distfiles.gentoo.org/releases/
网易镜像地址：http://mirrors.163.com/gentoo/releases/
</code></pre><pre><code>截止目前最新的是install-amd64-minimal-20180222T214502Z.iso

minimal镜像和stage3下载地址：
http://mirrors.163.com/gentoo/releases/amd64/autobuilds/current-stage3-amd64/

portage下载地址: 
http://mirrors.163.com/gentoo/releases/snapshots/current/portage-20180220.tar.bz2 

注：如果网络较好可以通过网络下载stage3和portage。如果提前下载需要拷贝到U盘里，需要的时候挂载解压。
我这边网络比较好，选择在安装的过程中从网上下载。
</code></pre><h5 id="制作引导U盘"><a href="#制作引导U盘" class="headerlink" title="制作引导U盘"></a>制作引导U盘</h5><pre><code>把iso刻录到U盘里，用来启动引导，这里推荐使用UltraISO，启动-&gt;写入硬盘镜像
</code></pre><h5 id="记录服务器硬件配置"><a href="#记录服务器硬件配置" class="headerlink" title="记录服务器硬件配置"></a>记录服务器硬件配置</h5><pre><code>因为在安装的过程中要自己编译内核，需要配置一些硬件驱动信息，主要是CPU、显卡、网卡，可以自行查看，配置选好的话可以节省很多编译时间和内核资源。
</code></pre><h4 id="安装基本系统"><a href="#安装基本系统" class="headerlink" title="安装基本系统"></a>安装基本系统</h4><pre><code>从U盘启动，在boot处输入: gentoo dopcmcia ,根据引导进入命令行模式,接下来安装基本系统。
</code></pre><h5 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h5><pre><code>建议分区规划
bios_grub        BIOS启动分区，官方是2M,我这里给9M  
boot    300M     启动系统目录,挂载目录: /mnt/gentoo/boot
swap   8192M     
/     剩余All      挂载目录: /mnt/gentoo

注：系统使用BIOS引导方式,所以不需要EFI分区
</code></pre><pre><code>分区格式（MBR或GPT）直接影响到后边的GRUB引导,本例是MBR分区（BIOS引导方式）
livecd # parted
select /dev/sda   #选择操作的磁盘
mklabel gpt    #分区格式使用MBR
mkpart primary 1M 10M   #BIOS启动分区必须有,否则grub安装出错
name 1 grub
set 1 bios_grub on   #设置BIOS分区可启动

mkpart primary 10M 310M   #boot系统分区
name 2 boot
set 2 boot on    #设置boot分区为可启动

mkpart primary 310M 8502M   #swap分区
name 3 swap
mkpart primary 8502M -1  #剩余全部给根分区
name 4 bootfs
p     查看分区
quit  退出parted
----------------------------------------------
格式化
mkfs.ext2  /dev/sda1  格式化预留空间分区
mkfs.ext2  /dev/sda2  格式化boot分区
mkswap /dev/sda3        格式化swap分区
mkfs.ext4 /dev/sda4     格式化根分区
----------------------------------------------
挂载到/mnt/下
mount /dev/sda4 /mnt/gentoo   先挂载根分区
mkdir -p /mnt/gentoo/boot  创建boot挂载目录
mount /dev/sda2 /mnt/gentoo/boot  挂载boot
swapon /dev/sda3   挂载swap
</code></pre><pre><code>分区相关-知识点总结:

(1)如果是MBR分区的磁盘，使用以下方法创建ESP：
parted创建的boot_grub和boot分区, 使用mkfs.ext2格式化
-----------------------------------------------------------------------------------------------
(2)关于parted set命令的flag类型,可参考官方文档: https://www.gnu.org/software/parted/manual/html_node/set.html
</code></pre><h5 id="配置网络"><a href="#配置网络" class="headerlink" title="配置网络"></a>配置网络</h5><pre><code>配置网络主要是用来下载portage和stage,如果已经下载到U盘里,直接挂载U盘拷贝到/mnt/gentoo/os目录下。
使用如下命令来配置网络:
ifconfig   查看网络标识
net-setup eno16777728  根据提示输入IP地址、broadcast、netmask、gateway、DNS和dns search suffix地址(如:qq.com)
使用ping qq.com来测试网络是否可用

官方网络配置参考：https://wiki.gentoo.org/wiki/Handbook:X86/Installation/Networking#Manual_network_configuration
</code></pre><pre><code>开启ssh，配置后边的东西会方便很多，比如:命令粘贴或文件粘贴
/etc/init.d/sshd start  #启动ssh服务
passwd root   #修改root密码

此时就可以使用xshell连接了
</code></pre><pre><code>使用links命令把portage和stage下载到/mnt/gentoo里
cd /mnt/gentoo/  #切换到挂载的根分区下载包(只有这个有大空间)
links mirrors.163.com/gentoo
注: stage在releases/x86/current-iso/目录下; portage在snapshots/目录下

#解压(按照下面顺序解压)
xz -d stage3-amd64-20180225T214502Z.tar.xz &amp;&amp; tar -xf stage3-amd64-20180225T214502Z.tar  
tar -xjf portage-20180220.tar.bz2 -C /mnt/gentoo/usr/
</code></pre><h5 id="配置make-conf"><a href="#配置make-conf" class="headerlink" title="配置make.conf"></a>配置make.conf</h5><pre><code>为了优化Gentoo，必须在软件编译的时候指定某些参数，这样编译出来的程序运行效率将非常高，系统在编译用到的参数就在make.conf里，文件路径是/mnt/gentoo/etc/portage/make.conf.
Gentoo给了我们一个配置的sample在/mnt/gentoo/usr/share/portage/config/make.conf.example，他里面讲的很详细，下面的是我的make.conf。
</code></pre><pre><code>vi /mnt/gentoo/etc/portage/make.conf

#USE用于控制软件的安装
USE=&quot;bindist mmx sse sse2&quot;  
#这两个变量使用相同的值,这两个变量定义gcc和c++编译器的优化
CFLAGS=&quot;-march=native -mtune=native -O2 -pipe&quot; 
CXXFLAGS=&quot;${CFLAGS}&quot; 
#指定gcc同时编译的数量,一般是CPU个数(或核心数）+1
MAKEOPTS=&quot;-j9&quot; 

注:&quot;-march=native&quot;参数,native意思是让系统自动检测cpu型号进行配置
</code></pre><h5 id="进入新环境"><a href="#进入新环境" class="headerlink" title="进入新环境"></a>进入新环境</h5><pre><code>接下来就可以进入新环境/mnt/gentoo, 在chroot进入新环境前需要做一些设备的挂载和DNS文件复制
cp -L /etc/resolv.conf /mnt/gentoo/etc/
mount -t proc none /mnt/gentoo/proc 
mount --rbind /sys /mnt/gentoo/sys
mount --make-rslave /mnt/gentoo/sys
mount --rbind /dev /mnt/gentoo/dev
mount --make-rslave /mnt/gentoo/dev
</code></pre><pre><code>使用chroot进入新环境,并更新环境变量
chroot /mnt/gentoo /bin/bash
env-update
source /etc/profile

为了使portage里的软件保持最新，最好同步一下
emerge --sync   
注:如果同步出错，需要检查/etc/portage/make.conf文件中的参数
</code></pre><pre><code>Gentoo中除了USE和CFLAGS用于优化外还有一个重要的profile，这个是Gentoo自带的配置文件，我们只要选择合适的就行了。

eselect profile list   #列出所有的子版本(带*号的是默认选项)
  [1]   default/linux/amd64/13.0 (stable)*
  [2]   default/linux/amd64/13.0/selinux (dev)
  [3]   default/linux/amd64/13.0/desktop (stable)
  [4]   default/linux/amd64/13.0/desktop/gnome (stable)
  [5]   default/linux/amd64/13.0/desktop/gnome/systemd (stable)
  ......

eselect profile set 12  #选择对应版本
</code></pre><h5 id="编译内核"><a href="#编译内核" class="headerlink" title="编译内核"></a>编译内核</h5><pre><code>选择一个内核并进行安装
emerge --ask sys-kernel/gentoo-sources

进入内核源码
cd /usr/src/linux

手动配置内核
make menuconfig

注：make menuconfig显示错误“Your display is too small to run Menuconfig!”
如果在终端执行 make menuconfig ,显示错误：
Your display is too small to run Menuconfig!
It must be at least 19 lines by 80 columns.
make[1]: *** [menuconfig] Error 1
make: *** [menuconfig] Error 2
表示xshell终端窗口太小。把终端窗口适当的调大（或是直接最大化）就行了。
</code></pre><pre><code>注：内核的配置可以参考官方文档:https://wiki.gentoo.org/wiki/Handbook:X86/Installation/Kernel
</code></pre><h6 id="内核-启用devtmpfs支持"><a href="#内核-启用devtmpfs支持" class="headerlink" title="内核:启用devtmpfs支持"></a>内核:启用devtmpfs支持</h6><pre><code>作用：用来挂载/dev,以便在启动过程中使用关键设备文件

Device Drivers ---&gt;
  Generic Driver Options ---&gt;
    [*] Maintain a devtmpfs filesystem to mount at /dev
    [*] Automount devtmpfs at /dev, after the kernel mounted the rootfs
</code></pre><h6 id="内核-启用SCSI磁盘支持"><a href="#内核-启用SCSI磁盘支持" class="headerlink" title="内核: 启用SCSI磁盘支持"></a>内核: 启用SCSI磁盘支持</h6><pre><code>Device Drivers ---&gt;
   SCSI device support  ---&gt;
      &lt;*&gt; SCSI disk support
</code></pre><h6 id="内核-选择必要的文件系统"><a href="#内核-选择必要的文件系统" class="headerlink" title="内核: 选择必要的文件系统"></a>内核: 选择必要的文件系统</h6><pre><code>建议常用的文件系统格式都选择上，免得用的时候抓瞎
File systems ---&gt;
  &lt;*&gt; Second extended fs support
  &lt;*&gt; The Extended 3 (ext3) filesystem
  &lt;*&gt; The Extended 4 (ext4) filesystem
  &lt;*&gt; Reiserfs support
  &lt;*&gt; JFS filesystem support
  &lt;*&gt; XFS filesystem support
  &lt;*&gt; Btrfs filesystem support
  DOS/FAT/NT Filesystems  ---&gt;
    &lt;*&gt; MSDOS fs support
    &lt;*&gt; VFAT (Windows-95) fs support
</code></pre><h6 id="内核-选择PPPoE必要的驱动程序"><a href="#内核-选择PPPoE必要的驱动程序" class="headerlink" title="内核: 选择PPPoE必要的驱动程序"></a>内核: 选择PPPoE必要的驱动程序</h6><pre><code>Device Drivers ---&gt;
  Network device support ---&gt;
    &lt;*&gt; PPP (point-to-point protocol) support
    &lt;*&gt;   PPP support for async serial ports
    &lt;*&gt;   PPP support for sync tty ports
</code></pre><h6 id="内核-激活SMP支持"><a href="#内核-激活SMP支持" class="headerlink" title="内核: 激活SMP支持"></a>内核: 激活SMP支持</h6><pre><code>作用：用于支持多内核存在,用来在多个内核间进行切换

Processor type and features  ---&gt;
  [*] Symmetric multi-processing support
</code></pre><p>内核: 启用输入设备的USB支持</p>
<pre><code>Device Drivers ---&gt;
  HID support  ---&gt;
    -*- HID bus support
    &lt;*&gt;   Generic HID driver
    [*]   Battery level reporting for HID devices
      USB HID support  ---&gt;
        &lt;*&gt; USB HID transport layer
  [*] USB support  ---&gt;
    &lt;*&gt;     xHCI HCD (USB 3.0) support
    &lt;*&gt;     EHCI HCD (USB 2.0) support
    &lt;*&gt;     OHCI HCD (USB 1.1) support
</code></pre><h6 id="内核-选择处理器类型和特点"><a href="#内核-选择处理器类型和特点" class="headerlink" title="内核: 选择处理器类型和特点"></a>内核: 选择处理器类型和特点</h6><pre><code>Processor type and features  ---&gt;
   [ ] Machine Check / overheating reporting 
   [ ]   Intel MCE Features
   [ ]   AMD MCE Features
   Processor family (AMD-Opteron/Athlon64)  ---&gt;
      ( ) Opteron/Athlon64/Hammer/K8
      ( ) Intel P4 / older Netburst based Xeon
      ( ) Core 2/newer Xeon
      ( ) Intel Atom
      ( ) Generic-x86-64
Executable file formats / Emulations  ---&gt;
   [*] IA32 Emulation
</code></pre><h6 id="内核-启用对GPT的支持-用于支持GPT分区"><a href="#内核-启用对GPT的支持-用于支持GPT分区" class="headerlink" title="内核: 启用对GPT的支持(用于支持GPT分区)"></a>内核: 启用对GPT的支持(用于支持GPT分区)</h6><pre><code>-*- Enable the block layer ---&gt;
   Partition Types ---&gt;
      [*] Advanced partition selection
      [*] EFI GUID Partition support
</code></pre><h6 id="内核-启用对UEFI方式引导系统的支持"><a href="#内核-启用对UEFI方式引导系统的支持" class="headerlink" title="内核: 启用对UEFI方式引导系统的支持"></a>内核: 启用对UEFI方式引导系统的支持</h6><pre><code>注:如果不启用,则系统不能通过UEFI方式引导

Processor type and features  ---&gt;
    [*] EFI runtime service support 
    [*]   EFI stub support
    [*]     EFI mixed-mode support

Firmware Drivers  ---&gt;
    EFI (Extensible Firmware Interface) Support  ---&gt;
        &lt;*&gt; EFI Variable Support via sysfs
</code></pre><pre><code>编译并安装模块
make &amp;&amp; make modules_install

内核编译完成后，使用如下命令将内核镜像复制到/boot/目录中
make install
</code></pre><h4 id="配置系统"><a href="#配置系统" class="headerlink" title="配置系统"></a>配置系统</h4><pre><code>emerge app-editors/vim    #安装vim
</code></pre><h5 id="配置fstab"><a href="#配置fstab" class="headerlink" title="配置fstab"></a>配置fstab</h5><pre><code>vim /etc/fstab
/dev/sda4  /    ext4  defaults 1 1             #配置挂载根分区
/dev/sda3  none  swap  sw  0 0                 #配置挂载swap
/dev/sda2  /boot ext2  noauto,noatime    1 2    #配置挂载boot分区

注: 生产环境下,最前面的/dev/sda1、sda2、sda3要通过blkid命令替换成对应的UUID
</code></pre><p>配置主机名</p>
<pre><code>vim /etc/conf.d/hostname

hostname =“gentoo”  ＃将主机名变量设置为所选主机名
</code></pre><h5 id="配置网络-1"><a href="#配置网络-1" class="headerlink" title="配置网络"></a>配置网络</h5><pre><code>这次是配置的系统网络，而非LiveCD的网络
emerge --ask --noreplace net-misc/netifrc


vi /etc/conf.d/net   #配置静态IP
config_eth0=&quot;10.0.10.100 netmask 255.255.255.0 brd 10.0.10.255&quot;
routes_eth0=&quot;default via 10.0.10.1&quot;

注：如果系统自动获取IP则进行如下配置
config_eth0=&quot;dhcp&quot;
</code></pre><h5 id="系统启动时激活网卡配置"><a href="#系统启动时激活网卡配置" class="headerlink" title="系统启动时激活网卡配置"></a>系统启动时激活网卡配置</h5><pre><code>cd /etc/init.d
ln -s net.lo net.eth0
rc-update add net.eth0 default
</code></pre><pre><code>排错
如果在启动系统后，我们发现有关网络接口名称（目前记录为eth0）的假设是错误的，那么执行以下步骤来解决这个问题：
使用正确的接口名称更新/etc/conf.d/net文件（enp3s0而不是eth0）。
创建新的符号链接（如/etc/init.d/net.enp3s0）。
删除旧的符号链接（rm /etc/init.d/net.eth0）。
将新的添加到默认运行级别。
使用rc-update del net.eth0默认值删除旧的。
</code></pre><h5 id="定义hosts文件"><a href="#定义hosts文件" class="headerlink" title="定义hosts文件"></a>定义hosts文件</h5><pre><code>vim  /etc/hosts
127.0.0.1 gentoo.homenetwork gentoo localhost   ＃这定义了当前系统并且必须设置
</code></pre><h5 id="系统信息"><a href="#系统信息" class="headerlink" title="系统信息"></a>系统信息</h5><pre><code>使用passwd命令设置root密码。
</code></pre><p>配置rc.conf文件</p>
<pre><code>作用: Gentoo使用/etc/rc.conf来配置系统的服务，启动和关闭。

打开/etc/rc.conf并享受文件中的所有注释。查看设置并在需要的地方进行更改。
</code></pre><h5 id="中文语言支持"><a href="#中文语言支持" class="headerlink" title="中文语言支持"></a>中文语言支持</h5><pre><code>vim /etc/locale.gen
en_US ISO-8859-1
en_US.UTF-8 UTF-8
#把需要的项前面的#号去掉

执行
locale-gen
</code></pre><h5 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h5><pre><code>cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone

#设置硬件时间为本地，不然会多8个小时
hwclock -w --localtime
</code></pre><h5 id="安装系统日志记录器"><a href="#安装系统日志记录器" class="headerlink" title="安装系统日志记录器"></a>安装系统日志记录器</h5><pre><code>作用：提供传统的系统日志守护进程
emerge --ask app-admin/sysklogd  
rc-update add sysklogd default
</code></pre><h5 id="安装crond定时任务"><a href="#安装crond定时任务" class="headerlink" title="安装crond定时任务"></a>安装crond定时任务</h5><pre><code>作用：cron守护进程执行预定的命令。如果需要定期执行某些命令（例如每天，每周或每月），这非常方便。
emerge --ask sys-process/cronie
rc-update add cronie default

如果使用dcron或fcron，则需要执行额外的初始化命令：
crontab /etc/crontab
</code></pre><h5 id="远程访问"><a href="#远程访问" class="headerlink" title="远程访问"></a>远程访问</h5><pre><code>rc-update add sshd default     #添加ssh开机自启动
</code></pre><h5 id="文件索引"><a href="#文件索引" class="headerlink" title="文件索引"></a>文件索引</h5><pre><code>作用：为了索引文件系统以提供更快的文件位置功能
emerge --ask sys-apps/mlocate
</code></pre><h5 id="文件系统工具"><a href="#文件系统工具" class="headerlink" title="文件系统工具"></a>文件系统工具</h5><pre><code>作用: 用于检查文件系统完整性，创建其他文件系统等,按需安装

emerge     sys-fs/e2fsprogs     用于管理Ext2, Ext3, EXT4
emerge  sys-fs/xfsprogs      用于管理XFS
emerge  sys-fs/reiserfsprogs 用于管理ReiserFS
emerge  sys-fs/jfsutils      用于管理JFS
emerge  sys-fs/dosfstools    用于管理VFAT（如：FAT32、NTFS等）
emerge  sys-fs/btrfs-progs   用于管理Btrfs
</code></pre><h5 id="配置GRUB引导"><a href="#配置GRUB引导" class="headerlink" title="配置GRUB引导"></a>配置GRUB引导</h5><pre><code>(1)修改vim /etc/portage/make.conf
添加：
# Both UEFI and PC
GRUB_PLATFORMS=&quot;efi-64 pc&quot;

(2)MBR分区-BIOS方式引导
emerge --ask sys-boot/grub:2

(3)安装到MBR。假定第一个（系统引导的）磁盘是/dev/sda
grub-install /dev/sda

(4)自动生成grub2配置
grub-mkconfig -o /boot/grub/grub.cfg   

(5)保险起见再次执行一次这个命令
   grub-install /dev/sda
</code></pre><h5 id="现在基本系统安装完成，卸载分区，重启。"><a href="#现在基本系统安装完成，卸载分区，重启。" class="headerlink" title="现在基本系统安装完成，卸载分区，重启。"></a>现在基本系统安装完成，卸载分区，重启。</h5><pre><code>exit
umount -l /mnt/gentoo/dev
umount -l /mnt/gentoo/proc
umount -l /mnt/gentoo/sys
umount -l /mnt/gentoo
reboot
</code></pre><h6 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h6><pre><code>Grub引导正常，但启动系统过程中,出现 LFS kernel panic -not syncing :VFS:Unable to mount root fs on Unknown-block(0,0)
</code></pre><pre><code>原因：
(1)进入LiveCD，挂载根和boot分区,然后修改修改/etc/fstab文件
注:一律使用uuid替代/dev/sdx

(2)内核编译的时候没有添加相应的硬件模块,建议只增不减。
</code></pre>
      
    </div>
    <footer class="article-footer">
      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Gentoo/">Gentoo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kernel/">Kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内核编译/">内核编译</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/高级运维/">高级运维</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/02/26/mysql主从复制错误-错误号1236/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          mysql主从复制错误-错误号1236
        
      </div>
    </a>
  
  
    <a href="/2018/02/23/MongoDB之用户授权管理/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">MongoDB之用户授权管理</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#准备工作"><span class="nav-number">1.</span> <span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#下载minimal镜像"><span class="nav-number">1.1.</span> <span class="nav-text">下载minimal镜像</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#制作引导U盘"><span class="nav-number">1.2.</span> <span class="nav-text">制作引导U盘</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#记录服务器硬件配置"><span class="nav-number">1.3.</span> <span class="nav-text">记录服务器硬件配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装基本系统"><span class="nav-number">2.</span> <span class="nav-text">安装基本系统</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#分区"><span class="nav-number">2.1.</span> <span class="nav-text">分区</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置网络"><span class="nav-number">2.2.</span> <span class="nav-text">配置网络</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置make-conf"><span class="nav-number">2.3.</span> <span class="nav-text">配置make.conf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#进入新环境"><span class="nav-number">2.4.</span> <span class="nav-text">进入新环境</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编译内核"><span class="nav-number">2.5.</span> <span class="nav-text">编译内核</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#内核-启用devtmpfs支持"><span class="nav-number">2.5.1.</span> <span class="nav-text">内核:启用devtmpfs支持</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#内核-启用SCSI磁盘支持"><span class="nav-number">2.5.2.</span> <span class="nav-text">内核: 启用SCSI磁盘支持</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#内核-选择必要的文件系统"><span class="nav-number">2.5.3.</span> <span class="nav-text">内核: 选择必要的文件系统</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#内核-选择PPPoE必要的驱动程序"><span class="nav-number">2.5.4.</span> <span class="nav-text">内核: 选择PPPoE必要的驱动程序</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#内核-激活SMP支持"><span class="nav-number">2.5.5.</span> <span class="nav-text">内核: 激活SMP支持</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#内核-选择处理器类型和特点"><span class="nav-number">2.5.6.</span> <span class="nav-text">内核: 选择处理器类型和特点</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#内核-启用对GPT的支持-用于支持GPT分区"><span class="nav-number">2.5.7.</span> <span class="nav-text">内核: 启用对GPT的支持(用于支持GPT分区)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#内核-启用对UEFI方式引导系统的支持"><span class="nav-number">2.5.8.</span> <span class="nav-text">内核: 启用对UEFI方式引导系统的支持</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置系统"><span class="nav-number">3.</span> <span class="nav-text">配置系统</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#配置fstab"><span class="nav-number">3.1.</span> <span class="nav-text">配置fstab</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置网络-1"><span class="nav-number">3.2.</span> <span class="nav-text">配置网络</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#系统启动时激活网卡配置"><span class="nav-number">3.3.</span> <span class="nav-text">系统启动时激活网卡配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#定义hosts文件"><span class="nav-number">3.4.</span> <span class="nav-text">定义hosts文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#系统信息"><span class="nav-number">3.5.</span> <span class="nav-text">系统信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#中文语言支持"><span class="nav-number">3.6.</span> <span class="nav-text">中文语言支持</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改时区"><span class="nav-number">3.7.</span> <span class="nav-text">修改时区</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装系统日志记录器"><span class="nav-number">3.8.</span> <span class="nav-text">安装系统日志记录器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装crond定时任务"><span class="nav-number">3.9.</span> <span class="nav-text">安装crond定时任务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#远程访问"><span class="nav-number">3.10.</span> <span class="nav-text">远程访问</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#文件索引"><span class="nav-number">3.11.</span> <span class="nav-text">文件索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#文件系统工具"><span class="nav-number">3.12.</span> <span class="nav-text">文件系统工具</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置GRUB引导"><span class="nav-number">3.13.</span> <span class="nav-text">配置GRUB引导</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#现在基本系统安装完成，卸载分区，重启。"><span class="nav-number">3.14.</span> <span class="nav-text">现在基本系统安装完成，卸载分区，重启。</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#故障处理"><span class="nav-number">3.14.1.</span> <span class="nav-text">故障处理</span></a></li></ol></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2018 Gary Wu All Rights Reserved.</p>
	      
	      
  		   	<p id="copyRightCn">Gary Wu 保留所有权利</p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>




  <script src="/js/dialog.js"></script>














  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Gary Wu
          </div>
          <div class="panel-body">
            Copyright © 2018 Gary Wu All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>