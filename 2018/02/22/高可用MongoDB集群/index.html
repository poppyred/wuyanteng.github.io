<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>高可用mongodb集群 | Gary Wu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="高级运维高可用MongoMongoDB路由分片副本集" />
  
  
  
  
  <meta name="description" content="MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件：mongos、config server、shard、replica set。">
<meta name="keywords" content="高级运维,高可用,Mongo,MongoDB,路由,分片,副本集">
<meta property="og:type" content="article">
<meta property="og:title" content="高可用MongoDB集群">
<meta property="og:url" content="https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/index.html">
<meta property="og:site_name" content="Gary Wu">
<meta property="og:description" content="MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件：mongos、config server、shard、replica set。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/mongo-fenpian.png">
<meta property="og:updated_time" content="2018-02-23T03:08:57.370Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="高可用MongoDB集群">
<meta name="twitter:description" content="MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件：mongos、config server、shard、replica set。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/mongo-fenpian.png">
  
    <link rel="alternate" href="/atom.xml" title="Gary Wu" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpg">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-高可用MongoDB集群" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      高可用MongoDB集群
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/02/22/高可用MongoDB集群/" class="article-date">
	  <time datetime="2018-02-22T05:43:33.000Z" itemprop="datePublished">2018-02-22</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件：mongos、config server、shard、replica set。</p>
<a id="more"></a>
<p><img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/mongo-fenpian.png" alt="mongo高可用集群"></p>
<!-- more -->
<h4 id="mongos"><a href="#mongos" class="headerlink" title="mongos"></a>mongos</h4><pre><code>mongos，数据库集群请求的入口，所有的请求都通过mongos进行协调，不需要在应用程序添加一个路由选择器，mongos自己就是一个请求分发中心，它负责把对应的数据请求请求转发到对应的shard服务器上。在生产环境通常有多mongos作为请求的入口，防止其中一个挂掉所有的mongodb请求都没有办法操作。
</code></pre><h4 id="config-server"><a href="#config-server" class="headerlink" title="config server"></a>config server</h4><pre><code>config server，顾名思义为配置服务器，存储所有数据库元信息（路由、分片）的配置。mongos本身没有物理存储分片服务器和数据路由信息，只是缓存在内存里，配置服务器则实际存储这些数据。mongos第一次启动或者关掉重启就会从 config server 加载配置信息，以后如果配置服务器信息变化会通知到所有的 mongos 更新自己的状态，这样 mongos 就能继续准确路由。在生产环境通常有多个 config server 配置服务器，因为它存储了分片路由的元数据，防止数据丢失！
</code></pre><h4 id="shard"><a href="#shard" class="headerlink" title="shard"></a>shard</h4><pre><code>shard，分片（sharding）是指将数据库拆分，将其分散在不同的机器上的过程。将数据分散到不同的机器上，不需要功能强大的服务器就可以存储更多的数据和处理更大的负载。基本思想就是将集合切成小块，这些块分散到若干片里，每个片只负责总数据的一部分，最后通过一个均衡器来对各个分片进行均衡（数据迁移）。
</code></pre><h4 id="replica-set"><a href="#replica-set" class="headerlink" title="replica set"></a>replica set</h4><pre><code>replica set，中文翻译副本集，其实就是shard的备份，防止shard挂掉之后数据丢失。复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。
</code></pre><h4 id="仲裁者"><a href="#仲裁者" class="headerlink" title="仲裁者"></a>仲裁者</h4><pre><code>仲裁者（Arbiter），是复制集中的一个MongoDB实例，它并不保存数据。仲裁节点使用最小的资源并且不要求硬件设备，不能将Arbiter部署在同一个数据集节点中，可以部署在其他应用服务器或者监视服务器中，也可部署在单独的虚拟机中。为了确保复制集中有奇数的投票成员（包括primary），需要添加仲裁节点做为投票，否则primary不能运行时不会自动切换primary。
</code></pre><h4 id="架构原理-总结"><a href="#架构原理-总结" class="headerlink" title="架构原理-总结"></a>架构原理-总结</h4><pre><code>简单了解之后，我们可以这样总结一下，应用请求mongos来操作mongodb的增删改查，配置服务器存储数据库元信息，并且和mongos做同步，数据最终存入在shard（分片）上，为了防止数据丢失同步在副本集中存储了一份，仲裁在数据存储到分片的时候决定存储到哪个节点。
</code></pre><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><pre><code>操作系统: CentOS7.2
服务器: 3台 - 10.0.10.25/26/27
Mongo版本： 3.4.6(mongodb-linux-x86_64-3.4.6.tgz)
</code></pre><h5 id="服务器规划"><a href="#服务器规划" class="headerlink" title="服务器规划"></a>服务器规划</h5><table>
<thead>
<tr>
<th style="text-align:center">服务器25</th>
<th style="text-align:center">服务器26</th>
<th style="text-align:center">服务器27</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">mongos</td>
<td style="text-align:center">mongos</td>
<td style="text-align:center">mongos</td>
</tr>
<tr>
<td style="text-align:center">config server</td>
<td style="text-align:center">config server</td>
<td style="text-align:center">config server</td>
</tr>
<tr>
<td style="text-align:center">shard server1主节点</td>
<td style="text-align:center">shard server1副节点</td>
<td style="text-align:center">shard server1仲裁节点</td>
</tr>
<tr>
<td style="text-align:center">shard server2仲裁节点</td>
<td style="text-align:center">shard server2主节点</td>
<td style="text-align:center">shard server2副节点</td>
</tr>
<tr>
<td style="text-align:center">shard server3主节点</td>
<td style="text-align:center">shard server3仲裁节点</td>
<td style="text-align:center">shard server3副节点</td>
</tr>
</tbody>
</table>
<h5 id="端口分配"><a href="#端口分配" class="headerlink" title="端口分配"></a>端口分配</h5><table>
<thead>
<tr>
<th style="text-align:center">mongos</th>
<th style="text-align:center">config server</th>
<th style="text-align:center">shard server1</th>
<th style="text-align:center">shard server2</th>
<th style="text-align:center">shard server3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">20000</td>
<td style="text-align:center">21000</td>
<td style="text-align:center">27001</td>
<td style="text-align:center">27002</td>
<td style="text-align:center">27003</td>
</tr>
</tbody>
</table>
<h4 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h4><h4 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h4><pre><code>mongodb3.4.6下载: https://www.mongodb.org/dl/linux/x86_64

解压到/usr/local
tar -zxvf mongodb-linux-x86_64-3.4.6.tgz -C /usr/local/

软链
ln -sv /usr/local/mongodb-linux-x86_64-3.4.6 /usr/local/mongodb
ls -lh /usr/local/mongodb
</code></pre><p>分别在每台服务器建立conf、mongos、config、shard1、shard2、shard3六个目录</p>
<pre><code>注: 因为mongos不存储数据, 所以此处建立mongos目录用于存放pid。

mkdir -p /data/A/mongodb/conf
mkdir -p /data/A/mongodb/mongos   #只用来存放pid
mkdir -p /data/A/mongodb/config/data
mkdir -p /data/A/mongodb/shard1/data
mkdir -p /data/A/mongodb/shard2/data
mkdir -p /data/A/mongodb/shard3/data

mkdir -p /var/log/mongodb/mongos
mkdir -p /var/log/mongodb/config
mkdir -p /var/log/mongodb/shard1
mkdir -p /var/log/mongodb/shard2
mkdir -p /var/log/mongodb/shard3
</code></pre><p>配置环境变量</p>
<pre><code>cat &gt;&gt; /etc/profile &lt;&lt;EOF
export MONGODB_HOME=/usr/local/mongodb
export PATH=$PATH:$MONGODB_HOME/bin
EOF

使其生效
source /etc/profile
</code></pre><!-- more -->
<h4 id="config-server配置-3台机器"><a href="#config-server配置-3台机器" class="headerlink" title="config server配置(3台机器)"></a>config server配置(3台机器)</h4><pre><code>注: mongodb3.4及以后要求config server也需要创建副本集,否则集群部署不成功
</code></pre><p>3台服务器-分别添加配置文件</p>
<pre><code>vi /data/A/mongodb/conf/config.conf
</code></pre><pre><code>## 配置文件内容
pidfilepath = /data/A/mongodb/config/configsvr.pid
dbpath = /data/A/mongodb/config/data
logpath = /var/log/mongodb/config/congigsvr.log
logappend = true

bind_ip = 0.0.0.0
port = 21000
fork = true

#声明这是一个DB(config server)集群的配置
configsvr = true

#副本集名称(稍后初始化副本集需要使用)
replSet=configs

#设置最大连接数
maxConns=20000
</code></pre><p>启动3台服务器的config server</p>
<pre><code>启动
mongod -f /data/A/mongodb/conf/config.conf 

验证端口
[root@bogon ~]# ss -lntup |grep 21000
tcp    LISTEN     0      128       *:21000     *:*    users:((&quot;mongod&quot;,pid=2149,fd=7))

验证日志
[root@bogon ~]# tailf /var/log/mongodb/config/congigsvr.log
</code></pre><p>登陆任意一台配置服务器,初始化配置副本集</p>
<pre><code>#连接mongo config server
mongo --port 21000

#config变量
config = {
... _id: &quot;configs&quot;,
...   members : [
...        {_id : 0,host : &quot;10.0.10.25:21000&quot;},     #格式:IP:Port
...        {_id : 1,host : &quot;10.0.10.26:21000&quot;},
...        {_id : 2,host : &quot;10.0.10.27:21000&quot;}
...     ]
... }

#初始化副本集(初始化完成后, “&gt;”变成了“configs:SECONDARY&gt;”)
&gt; rs.initiate(config)
{ &quot;ok&quot; : 1 }
configs:SECONDARY&gt; 
</code></pre><p>其中, _id: “configs”应与配置文件中配置的副本集名称[replSet=configs]一致; </p>
<!-- more -->
<h4 id="配置分片副本集-3台机器"><a href="#配置分片副本集-3台机器" class="headerlink" title="配置分片副本集(3台机器)"></a>配置分片副本集(3台机器)</h4><h5 id="设置第一个分片副本集"><a href="#设置第一个分片副本集" class="headerlink" title="设置第一个分片副本集"></a>设置第一个分片副本集</h5><pre><code>vim /data/A/mongodb/conf/shard1.conf
</code></pre><pre><code>pidfilepath = /data/A/mongodb/shard1/shard1.pid
dbpath = /data/A/mongodb/shard1/data
logpath = /var/log/mongodb/shard1/shard1.log
logappend = true

bind_ip = 0.0.0.0
port = 27001
fork = true

#打开web监控(端口默认28001)
httpinterface=true
rest=true

#副本集名称
replSet=shard1

#声明这是一个DB(分片副本)集群的配置
shardsvr = true

#设置最大连接数
maxConns=20000
</code></pre><p>分别启动3台机器的shard1 server</p>
<pre><code>启动
mongod -f /data/A/mongodb/conf/shard1.conf

验证端口
[root@bogon ~]# ss -lntup |grep 27001
tcp    LISTEN     0      128    *:27001   *:*   users:((&quot;mongod&quot;,pid=2649,fd=7))

验证日志
[root@bogon ~]# tailf /var/log/mongodb/shard
</code></pre><p>在非仲裁服务器,初始化shard1副本集</p>
<pre><code>连接
mongo --port 27001

使用admin数据库(没有则创建)
use admin

定义副本集配置, 第三个节点的“arbiterOnly”:true 代表其为仲裁节点
&gt; config = {
... _id:&quot;shard1&quot;,
... members: [
...      {_id:0, host:&quot;10.0.10.25:27001&quot;},
...      {_id:1, host:&quot;10.0.10.26:27001&quot;},
...      {_id:2, host:&quot;10.0.10.27:27001&quot;, arbiterOnly:true}
...    ]
... }

初始化副本集配置
&gt; rs.initiate(config);
{ &quot;ok&quot; : 1 }
shard1:SECONDARY&gt; 
</code></pre><p>shard1 Web监控</p>
<pre><code>注: 配置文件中启用了Web监控,如何访问呢？
ss -lntup |grep mongo
tcp    LISTEN     0      128       *:21000    *:*   users:((&quot;mongod&quot;,pid=18173,fd=7))
tcp    LISTEN     0      128       *:27001    *:*   users:((&quot;mongod&quot;,pid=18265,fd=7))
tcp    LISTEN     0      128       *:28001    *:*   users:((&quot;mongod&quot;,pid=18265,fd=9))
可以看到, 端口多出来一个28001

Web访问：
        http://10.0.10.25:28001
        http://10.0.10.26:28001
        http://10.0.10.27:28001

查看shard1副本集状态:
        http://10.0.10.25:28001/_replSet
</code></pre><!-- more -->
<h5 id="设置第二个分片副本集"><a href="#设置第二个分片副本集" class="headerlink" title="设置第二个分片副本集"></a>设置第二个分片副本集</h5><pre><code>vim /data/A/mongodb/conf/shard2.conf
</code></pre><pre><code>pidfilepath = /data/A/mongodb/shard2/shard2.pid
dbpath = /data/A/mongodb/shard2/data
logpath = /var/log/mongodb/shard2/shard2.log
logappend = true

bind_ip = 0.0.0.0
port = 27002
fork = true

#打开web监控
httpinterface=true
rest=true

#副本集名称
replSet=shard2

#声明这是一个DB(分片副本)集群的配置
shardsvr = true

#设置最大连接数
maxConns=20000
</code></pre><p>分别启动3台机器的shard2 server</p>
<pre><code>启动shard2
mongod -f /data/A/mongodb/conf/shard2.conf

端口验证
[root@bogon ~]# ss -lntup |grep mongo
tcp    LISTEN     0      128       *:21000    *:*   users:((&quot;mongod&quot;,pid=2326,fd=7))
tcp    LISTEN     0      128       *:27001    *:*   users:((&quot;mongod&quot;,pid=2649,fd=7))
tcp    LISTEN     0      128       *:27002    *:*   users:((&quot;mongod&quot;,pid=2755,fd=7))
tcp    LISTEN     0      128       *:28001    *:*   users:((&quot;mongod&quot;,pid=2649,fd=9))
tcp    LISTEN     0      128       *:28002    *:*   users:((&quot;mongod&quot;,pid=2755,fd=9))

日志验证
tailf /var/log/mongodb/shard2/shard2.log
</code></pre><p>在非仲裁服务器，初始化shard2副本集</p>
<pre><code>连接
mongo --port 27002

使用admin数据库
use admin

定义副本集配置, 第三个节点的“arbiterOnly”:true 代表其为仲裁节点
&gt; config = {
... _id:&quot;shard2&quot;,
... members: [
...      {_id:0, host:&quot;10.0.10.25:27002&quot;,arbiterOnly:true},
...      {_id:1, host:&quot;10.0.10.26:27002&quot;},
...      {_id:2, host:&quot;10.0.10.27:27002&quot;}
...    ]
... }

初始化副本集配置
&gt; rs.initiate(config);
{ &quot;ok&quot; : 1 }
shard2:SECONDARY&gt; 
</code></pre><p>shard2 Web监控</p>
<pre><code>Web访问：
        http://10.0.10.25:28002
        http://10.0.10.26:28002
        http://10.0.10.27:28002

查看shard2副本集状态:
        http://10.0.10.25:28002/_replSet
</code></pre><!-- more -->
<h5 id="设置第三个分片副本集"><a href="#设置第三个分片副本集" class="headerlink" title="设置第三个分片副本集"></a>设置第三个分片副本集</h5><pre><code>vim /data/A/mongodb/conf/shard3.conf
</code></pre><pre><code>pidfilepath = /data/A/mongodb/shard3/shard3.pid
dbpath = /data/A/mongodb/shard3/data
logpath = /var/log/mongodb/shard3/shard3.log
logappend = true

bind_ip = 0.0.0.0
port = 27003
fork = true

#打开web监控
httpinterface=true
rest=true

#副本集名称
replSet=shard3

#声明这是一个DB(分片副本)集群的配置
shardsvr = true

#设置最大连接数
maxConns=20000
</code></pre><p>分别启动3台机器的shard3 server</p>
<pre><code>启动shard3
mongod -f /data/A/mongodb/conf/shard3.conf

端口验证
[root@bogon ~]# ss -lntup |grep mongo
tcp    LISTEN     0      128       *:21000  *:*   users:((&quot;mongod&quot;,pid=2326,fd=7))
tcp    LISTEN     0      128       *:27001  *:*   users:((&quot;mongod&quot;,pid=2649,fd=7))
tcp    LISTEN     0      128       *:27002  *:*   users:((&quot;mongod&quot;,pid=2755,fd=7))
tcp    LISTEN     0      128       *:27003  *:*   users:((&quot;mongod&quot;,pid=2827,fd=7))
tcp    LISTEN     0      128       *:28001  *:*   users:((&quot;mongod&quot;,pid=2649,fd=9))
tcp    LISTEN     0      128       *:28002  *:*   users:((&quot;mongod&quot;,pid=2755,fd=9))
tcp    LISTEN     0      128       *:28003  *:*   users:((&quot;mongod&quot;,pid=2827,fd=9))

日志验证
tailf /var/log/mongodb/shard3/shard3.log
</code></pre><p>在非仲裁服务器，初始化shard3副本集</p>
<pre><code>连接
mongo --port 27003

使用admin数据库
use admin

定义副本集配置, 第三个节点的“arbiterOnly”:true 代表其为仲裁节点
&gt; config = {
... _id:&quot;shard3&quot;,
... members: [
...      {_id:0, host:&quot;10.0.10.25:27003&quot;},
...      {_id:1, host:&quot;10.0.10.26:27003&quot;,arbiterOnly:true},
...      {_id:2, host:&quot;10.0.10.27:27003&quot;}
...    ]
... }

初始化副本集配置
&gt; rs.initiate(config);
{ &quot;ok&quot; : 1 }
shard3:SECONDARY&gt; 
</code></pre><p>shard3 Web监控</p>
<pre><code>Web访问：
        http://10.0.10.25:28003
        http://10.0.10.26:28003
        http://10.0.10.27:28003

查看shard3副本集状态:
        http://10.0.10.25:28003/_replSet
</code></pre><!-- more -->
<h4 id="配置路由服务-mongos"><a href="#配置路由服务-mongos" class="headerlink" title="配置路由服务 mongos"></a>配置路由服务 mongos</h4><p>先启动配置服务器和分片服务器,后启动路由实例（三台机器）</p>
<pre><code>vim /data/A/mongodb/conf/mongos.conf
</code></pre><pre><code>pidfilepath = /data/A/mongodb/mongos/mongos.pid
logpath = /var/log/mongodb/mongos/mongos.log
logappend = true

bind_ip = 0.0.0.0
port = 20000
fork = true

#监听的配置服务器,只能有1个或者3个 configs为配置服务器的副本集名字
configdb = configs/10.0.10.25:21000,10.0.10.26:21000,10.0.10.27:21000

#设置最大连接数
maxConns=20000
</code></pre><p>启用3台服务器的mongos</p>
<pre><code>启动(启动命令为mongos)
mongos -f /data/A/mongodb/conf/mongos.conf

验证端口
[root@bogon ~]# ss -lntup |grep mongos
tcp    LISTEN     0      128       *:20000   *:*  users:((&quot;mongos&quot;,pid=2933,fd=5))

验证日志
tailf /var/log/mongodb/mongos/mongos.log
</code></pre><!-- more -->
<h4 id="启用分片"><a href="#启用分片" class="headerlink" title="启用分片"></a>启用分片</h4><pre><code>目前已经成功部署了mongodb配置服务器、路由服务器，各个分片服务器，此时当应用程序连接到mongos路由服务器时并不能使用分片机制，还需要在程序里设置分片配置，让分片生效。
</code></pre><p>登陆任意一台mongos</p>
<pre><code>连接mongos
mongo --port 20000

使用admin数据库
use admin

串联路由服务器与分配副本集
sh.addShard(&quot;shard1/10.0.10.25:27001,10.0.10.26:27001,10.0.10.27:27001&quot;)
sh.addShard(&quot;shard2/10.0.10.25:27002,10.0.10.26:27002,10.0.10.27:27002&quot;)
sh.addShard(&quot;shard3/10.0.10.25:27003,10.0.10.26:27003,10.0.10.27:27003&quot;)

查看集群状态
sh.status()
</code></pre><!-- more -->
<h4 id="指定数据库自动分片及测试"><a href="#指定数据库自动分片及测试" class="headerlink" title="指定数据库自动分片及测试"></a>指定数据库自动分片及测试</h4><pre><code>目前配置服务、路由服务、分片服务、副本集服务都已经串联起来了，但我们的目的是希望插入数据，数据能够自动分片。连接在mongos上，准备让指定的数据库、指定的集合分片生效。
</code></pre><pre><code>连接mongos
mongo --port 20000

切换到admin
use admin

#指定testdb分片生效
db.runCommand( { enablesharding :&quot;testdb&quot;});

#指定数据库里需要分片的集合和片键
db.runCommand( { shardcollection : &quot;testdb.table1&quot;,key : {id: 1} } )
</code></pre><pre><code>我们设置testdb的 table1表需要分片，根据 id 自动分片到 shard1 ，shard2，shard3 上面去。要这样设置是因为不是所有mongodb 的数据库和表 都需要分片！
</code></pre><p>报错处理</p>
<pre><code>注:如果不切换到admin则会报错
mongos&gt; db.runCommand({enablesharding:&quot;test&quot;});  
{  
    &quot;ok&quot; : 0,  
    &quot;errmsg&quot; : &quot;enableSharding may only be run against the admin database.&quot;,  
    &quot;code&quot; : 13  
}
</code></pre><p>测试分片配置结果</p>
<pre><code>连接任意一个mongos
mongo  mongo 10.0.10.25:20000

使用testdb
use  testdb;

插入测试数据
mongos&gt; db.table1.insert({id:1,&quot;test1&quot;:&quot;testval1&quot;});
mongos&gt; db.table1.insert({id:2,&quot;test1&quot;:&quot;testval1&quot;});
mongos&gt; db.table1.insert({id:4,&quot;test1&quot;:&quot;testval1&quot;});
WriteResult({ &quot;nInserted&quot; : 1 })
</code></pre><p>查看分片情况如下，部分无关信息省掉了</p>
<pre><code>db.table1.stats();

{
        &quot;sharded&quot; : true,
        &quot;ns&quot; : &quot;testdb.table1&quot;,
        &quot;count&quot; : 100000,
        &quot;numExtents&quot; : 13,
        &quot;size&quot; : 5600000,
        &quot;storageSize&quot; : 22372352,
        &quot;totalIndexSize&quot; : 6213760,
        &quot;indexSizes&quot; : {
                &quot;_id_&quot; : 3335808,
                &quot;id_1&quot; : 2877952
        },
        &quot;avgObjSize&quot; : 56,
        &quot;nindexes&quot; : 2,
        &quot;nchunks&quot; : 3,
        &quot;shards&quot; : {
                &quot;shard1&quot; : {
                        &quot;ns&quot; : &quot;testdb.table1&quot;,
                        &quot;count&quot; : 42183,
                        &quot;size&quot; : 0,
                        ...
                        &quot;ok&quot; : 1
                },
                &quot;shard2&quot; : {
                        &quot;ns&quot; : &quot;testdb.table1&quot;,
                        &quot;count&quot; : 38937,
                        &quot;size&quot; : 2180472,
                        ...
                        &quot;ok&quot; : 1
                },
                &quot;shard3&quot; : {
                        &quot;ns&quot; : &quot;testdb.table1&quot;,
                        &quot;count&quot; :18880,
                        &quot;size&quot; : 3419528,
                        ...
                        &quot;ok&quot; : 1
                }
        },
        &quot;ok&quot; : 1
}
</code></pre><h4 id="后期运维"><a href="#后期运维" class="headerlink" title="后期运维"></a>后期运维</h4><pre><code>mongodb的启动顺序:  (先启动)配置服务器 --&gt;再启动分片 --&gt; 最后启动mongos.

mongod -f /data/A/mongodb/conf/config.conf
mongod -f /data/A/mongodb/conf/shard1.conf
mongod -f /data/A/mongodb/conf/shard2.conf
mongod -f /data/A/mongodb/conf/shard3.conf
mongos -f /data/A/mongodb/conf/mongos.conf

建议使用supervisor管理启动mongodb
</code></pre><p>参考：<a href="http://www.ityouknow.com/mongodb/2017/08/05/mongodb-cluster-setup.html" target="_blank" rel="noopener">mongodb3.4集群部署</a></p>

      
    </div>
    <footer class="article-footer">
      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mongo/">Mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分片/">分片</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/副本集/">副本集</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/路由/">路由</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/高可用/">高可用</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/高级运维/">高级运维</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/02/23/MongoDB之数据库管理/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          MongoDB之数据库管理
        
      </div>
    </a>
  
  
    <a href="/2018/02/16/gentoo-rc-update启动项管理/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">gentoo rc-update启动项管理</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#mongos"><span class="nav-number">1.</span> <span class="nav-text">mongos</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#config-server"><span class="nav-number">2.</span> <span class="nav-text">config server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shard"><span class="nav-number">3.</span> <span class="nav-text">shard</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#replica-set"><span class="nav-number">4.</span> <span class="nav-text">replica set</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#仲裁者"><span class="nav-number">5.</span> <span class="nav-text">仲裁者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#架构原理-总结"><span class="nav-number">6.</span> <span class="nav-text">架构原理-总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#环境准备"><span class="nav-number">7.</span> <span class="nav-text">环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#服务器规划"><span class="nav-number">7.1.</span> <span class="nav-text">服务器规划</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#端口分配"><span class="nav-number">7.2.</span> <span class="nav-text">端口分配</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群部署"><span class="nav-number">8.</span> <span class="nav-text">集群部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装MongoDB"><span class="nav-number">9.</span> <span class="nav-text">安装MongoDB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#config-server配置-3台机器"><span class="nav-number">10.</span> <span class="nav-text">config server配置(3台机器)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置分片副本集-3台机器"><span class="nav-number">11.</span> <span class="nav-text">配置分片副本集(3台机器)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#设置第一个分片副本集"><span class="nav-number">11.1.</span> <span class="nav-text">设置第一个分片副本集</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#设置第二个分片副本集"><span class="nav-number">11.2.</span> <span class="nav-text">设置第二个分片副本集</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#设置第三个分片副本集"><span class="nav-number">11.3.</span> <span class="nav-text">设置第三个分片副本集</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置路由服务-mongos"><span class="nav-number">12.</span> <span class="nav-text">配置路由服务 mongos</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启用分片"><span class="nav-number">13.</span> <span class="nav-text">启用分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指定数据库自动分片及测试"><span class="nav-number">14.</span> <span class="nav-text">指定数据库自动分片及测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#后期运维"><span class="nav-number">15.</span> <span class="nav-text">后期运维</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2018 Gary Wu All Rights Reserved.</p>
	      
	      
  		   	<p id="copyRightCn">Gary Wu 保留所有权利</p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>




  <script src="/js/dialog.js"></script>














  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Gary Wu
          </div>
          <div class="panel-body">
            Copyright © 2018 Gary Wu All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>