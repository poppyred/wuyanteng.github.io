<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>高可用MongoDB集群 | Gary Wu | 运维架构师 - 从入门到放弃</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="高级运维,高可用,Mongo,MongoDB,路由,分片,副本集">
    <meta name="description" content="MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件：mongos、config server、shard、replica set。">
<meta name="keywords" content="高级运维,高可用,Mongo,MongoDB,路由,分片,副本集">
<meta property="og:type" content="article">
<meta property="og:title" content="高可用MongoDB集群">
<meta property="og:url" content="https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/index.html">
<meta property="og:site_name" content="Gary Wu">
<meta property="og:description" content="MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件：mongos、config server、shard、replica set。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/mongo-fenpian.png">
<meta property="og:updated_time" content="2018-02-23T03:08:57.370Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="高可用MongoDB集群">
<meta name="twitter:description" content="MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件：mongos、config server、shard、replica set。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/mongo-fenpian.png">
    
        <link rel="alternate" type="application/atom+xml" title="Gary Wu" href="/atom.xml">
    
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/bingchuan.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/touxiang.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Gary Wu</h5>
          <a href="mailto:wuyanteng@foxmail.com" title="wuyanteng@foxmail.com" class="mail">wuyanteng@foxmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                所有文章
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/高级运维"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/wuyanteng" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://t.me/om_china" target="_blank" >
                <i class="icon icon-lg icon-link"></i>
                Telegram讨论组
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">高可用MongoDB集群</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入关键字来检索">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">高可用MongoDB集群</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-02-22T05:43:33.000Z" itemprop="datePublished" class="page-time">
  2018-02-22
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#mongos"><span class="post-toc-number">1.</span> <span class="post-toc-text">mongos</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#config-server"><span class="post-toc-number">2.</span> <span class="post-toc-text">config server</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#shard"><span class="post-toc-number">3.</span> <span class="post-toc-text">shard</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#replica-set"><span class="post-toc-number">4.</span> <span class="post-toc-text">replica set</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#仲裁者"><span class="post-toc-number">5.</span> <span class="post-toc-text">仲裁者</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#架构原理-总结"><span class="post-toc-number">6.</span> <span class="post-toc-text">架构原理-总结</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#环境准备"><span class="post-toc-number">7.</span> <span class="post-toc-text">环境准备</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#服务器规划"><span class="post-toc-number">7.1.</span> <span class="post-toc-text">服务器规划</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#端口分配"><span class="post-toc-number">7.2.</span> <span class="post-toc-text">端口分配</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#集群部署"><span class="post-toc-number">8.</span> <span class="post-toc-text">集群部署</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#安装MongoDB"><span class="post-toc-number">9.</span> <span class="post-toc-text">安装MongoDB</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#config-server配置-3台机器"><span class="post-toc-number">10.</span> <span class="post-toc-text">config server配置(3台机器)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配置分片副本集-3台机器"><span class="post-toc-number">11.</span> <span class="post-toc-text">配置分片副本集(3台机器)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#设置第一个分片副本集"><span class="post-toc-number">11.1.</span> <span class="post-toc-text">设置第一个分片副本集</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#设置第二个分片副本集"><span class="post-toc-number">11.2.</span> <span class="post-toc-text">设置第二个分片副本集</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#设置第三个分片副本集"><span class="post-toc-number">11.3.</span> <span class="post-toc-text">设置第三个分片副本集</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配置路由服务-mongos"><span class="post-toc-number">12.</span> <span class="post-toc-text">配置路由服务 mongos</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#启用分片"><span class="post-toc-number">13.</span> <span class="post-toc-text">启用分片</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#指定数据库自动分片及测试"><span class="post-toc-number">14.</span> <span class="post-toc-text">指定数据库自动分片及测试</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#后期运维"><span class="post-toc-number">15.</span> <span class="post-toc-text">后期运维</span></a></li></ol>
        </nav>
    </aside>


<article id="post-高可用MongoDB集群"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">高可用MongoDB集群</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-02-22 13:43:33" datetime="2018-02-22T05:43:33.000Z"  itemprop="datePublished">2018-02-22</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件：mongos、config server、shard、replica set。</p>
<a id="more"></a>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/mongo-fenpian.png" alt="mongo高可用集群" title="">
                </div>
                <div class="image-caption">mongo高可用集群</div>
            </figure>
<!-- more -->
<h4 id="mongos"><a href="#mongos" class="headerlink" title="mongos"></a>mongos</h4><pre><code>mongos，数据库集群请求的入口，所有的请求都通过mongos进行协调，不需要在应用程序添加一个路由选择器，mongos自己就是一个请求分发中心，它负责把对应的数据请求请求转发到对应的shard服务器上。在生产环境通常有多mongos作为请求的入口，防止其中一个挂掉所有的mongodb请求都没有办法操作。
</code></pre><h4 id="config-server"><a href="#config-server" class="headerlink" title="config server"></a>config server</h4><pre><code>config server，顾名思义为配置服务器，存储所有数据库元信息（路由、分片）的配置。mongos本身没有物理存储分片服务器和数据路由信息，只是缓存在内存里，配置服务器则实际存储这些数据。mongos第一次启动或者关掉重启就会从 config server 加载配置信息，以后如果配置服务器信息变化会通知到所有的 mongos 更新自己的状态，这样 mongos 就能继续准确路由。在生产环境通常有多个 config server 配置服务器，因为它存储了分片路由的元数据，防止数据丢失！
</code></pre><h4 id="shard"><a href="#shard" class="headerlink" title="shard"></a>shard</h4><pre><code>shard，分片（sharding）是指将数据库拆分，将其分散在不同的机器上的过程。将数据分散到不同的机器上，不需要功能强大的服务器就可以存储更多的数据和处理更大的负载。基本思想就是将集合切成小块，这些块分散到若干片里，每个片只负责总数据的一部分，最后通过一个均衡器来对各个分片进行均衡（数据迁移）。
</code></pre><h4 id="replica-set"><a href="#replica-set" class="headerlink" title="replica set"></a>replica set</h4><pre><code>replica set，中文翻译副本集，其实就是shard的备份，防止shard挂掉之后数据丢失。复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。
</code></pre><h4 id="仲裁者"><a href="#仲裁者" class="headerlink" title="仲裁者"></a>仲裁者</h4><pre><code>仲裁者（Arbiter），是复制集中的一个MongoDB实例，它并不保存数据。仲裁节点使用最小的资源并且不要求硬件设备，不能将Arbiter部署在同一个数据集节点中，可以部署在其他应用服务器或者监视服务器中，也可部署在单独的虚拟机中。为了确保复制集中有奇数的投票成员（包括primary），需要添加仲裁节点做为投票，否则primary不能运行时不会自动切换primary。
</code></pre><h4 id="架构原理-总结"><a href="#架构原理-总结" class="headerlink" title="架构原理-总结"></a>架构原理-总结</h4><pre><code>简单了解之后，我们可以这样总结一下，应用请求mongos来操作mongodb的增删改查，配置服务器存储数据库元信息，并且和mongos做同步，数据最终存入在shard（分片）上，为了防止数据丢失同步在副本集中存储了一份，仲裁在数据存储到分片的时候决定存储到哪个节点。
</code></pre><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><pre><code>操作系统: CentOS7.2
服务器: 3台 - 10.0.10.25/26/27
Mongo版本： 3.4.6(mongodb-linux-x86_64-3.4.6.tgz)
</code></pre><h5 id="服务器规划"><a href="#服务器规划" class="headerlink" title="服务器规划"></a>服务器规划</h5><table>
<thead>
<tr>
<th style="text-align:center">服务器25</th>
<th style="text-align:center">服务器26</th>
<th style="text-align:center">服务器27</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">mongos</td>
<td style="text-align:center">mongos</td>
<td style="text-align:center">mongos</td>
</tr>
<tr>
<td style="text-align:center">config server</td>
<td style="text-align:center">config server</td>
<td style="text-align:center">config server</td>
</tr>
<tr>
<td style="text-align:center">shard server1主节点</td>
<td style="text-align:center">shard server1副节点</td>
<td style="text-align:center">shard server1仲裁节点</td>
</tr>
<tr>
<td style="text-align:center">shard server2仲裁节点</td>
<td style="text-align:center">shard server2主节点</td>
<td style="text-align:center">shard server2副节点</td>
</tr>
<tr>
<td style="text-align:center">shard server3主节点</td>
<td style="text-align:center">shard server3仲裁节点</td>
<td style="text-align:center">shard server3副节点</td>
</tr>
</tbody>
</table>
<h5 id="端口分配"><a href="#端口分配" class="headerlink" title="端口分配"></a>端口分配</h5><table>
<thead>
<tr>
<th style="text-align:center">mongos</th>
<th style="text-align:center">config server</th>
<th style="text-align:center">shard server1</th>
<th style="text-align:center">shard server2</th>
<th style="text-align:center">shard server3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">20000</td>
<td style="text-align:center">21000</td>
<td style="text-align:center">27001</td>
<td style="text-align:center">27002</td>
<td style="text-align:center">27003</td>
</tr>
</tbody>
</table>
<h4 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h4><h4 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h4><pre><code>mongodb3.4.6下载: https://www.mongodb.org/dl/linux/x86_64

解压到/usr/local
tar -zxvf mongodb-linux-x86_64-3.4.6.tgz -C /usr/local/

软链
ln -sv /usr/local/mongodb-linux-x86_64-3.4.6 /usr/local/mongodb
ls -lh /usr/local/mongodb
</code></pre><p>分别在每台服务器建立conf、mongos、config、shard1、shard2、shard3六个目录</p>
<pre><code>注: 因为mongos不存储数据, 所以此处建立mongos目录用于存放pid。

mkdir -p /data/A/mongodb/conf
mkdir -p /data/A/mongodb/mongos   #只用来存放pid
mkdir -p /data/A/mongodb/config/data
mkdir -p /data/A/mongodb/shard1/data
mkdir -p /data/A/mongodb/shard2/data
mkdir -p /data/A/mongodb/shard3/data

mkdir -p /var/log/mongodb/mongos
mkdir -p /var/log/mongodb/config
mkdir -p /var/log/mongodb/shard1
mkdir -p /var/log/mongodb/shard2
mkdir -p /var/log/mongodb/shard3
</code></pre><p>配置环境变量</p>
<pre><code>cat &gt;&gt; /etc/profile &lt;&lt;EOF
export MONGODB_HOME=/usr/local/mongodb
export PATH=$PATH:$MONGODB_HOME/bin
EOF

使其生效
source /etc/profile
</code></pre><!-- more -->
<h4 id="config-server配置-3台机器"><a href="#config-server配置-3台机器" class="headerlink" title="config server配置(3台机器)"></a>config server配置(3台机器)</h4><pre><code>注: mongodb3.4及以后要求config server也需要创建副本集,否则集群部署不成功
</code></pre><p>3台服务器-分别添加配置文件</p>
<pre><code>vi /data/A/mongodb/conf/config.conf
</code></pre><pre><code>## 配置文件内容
pidfilepath = /data/A/mongodb/config/configsvr.pid
dbpath = /data/A/mongodb/config/data
logpath = /var/log/mongodb/config/congigsvr.log
logappend = true

bind_ip = 0.0.0.0
port = 21000
fork = true

#声明这是一个DB(config server)集群的配置
configsvr = true

#副本集名称(稍后初始化副本集需要使用)
replSet=configs

#设置最大连接数
maxConns=20000
</code></pre><p>启动3台服务器的config server</p>
<pre><code>启动
mongod -f /data/A/mongodb/conf/config.conf 

验证端口
[root@bogon ~]# ss -lntup |grep 21000
tcp    LISTEN     0      128       *:21000     *:*    users:((&quot;mongod&quot;,pid=2149,fd=7))

验证日志
[root@bogon ~]# tailf /var/log/mongodb/config/congigsvr.log
</code></pre><p>登陆任意一台配置服务器,初始化配置副本集</p>
<pre><code>#连接mongo config server
mongo --port 21000

#config变量
config = {
... _id: &quot;configs&quot;,
...   members : [
...        {_id : 0,host : &quot;10.0.10.25:21000&quot;},     #格式:IP:Port
...        {_id : 1,host : &quot;10.0.10.26:21000&quot;},
...        {_id : 2,host : &quot;10.0.10.27:21000&quot;}
...     ]
... }

#初始化副本集(初始化完成后, “&gt;”变成了“configs:SECONDARY&gt;”)
&gt; rs.initiate(config)
{ &quot;ok&quot; : 1 }
configs:SECONDARY&gt; 
</code></pre><p>其中, _id: “configs”应与配置文件中配置的副本集名称[replSet=configs]一致; </p>
<!-- more -->
<h4 id="配置分片副本集-3台机器"><a href="#配置分片副本集-3台机器" class="headerlink" title="配置分片副本集(3台机器)"></a>配置分片副本集(3台机器)</h4><h5 id="设置第一个分片副本集"><a href="#设置第一个分片副本集" class="headerlink" title="设置第一个分片副本集"></a>设置第一个分片副本集</h5><pre><code>vim /data/A/mongodb/conf/shard1.conf
</code></pre><pre><code>pidfilepath = /data/A/mongodb/shard1/shard1.pid
dbpath = /data/A/mongodb/shard1/data
logpath = /var/log/mongodb/shard1/shard1.log
logappend = true

bind_ip = 0.0.0.0
port = 27001
fork = true

#打开web监控(端口默认28001)
httpinterface=true
rest=true

#副本集名称
replSet=shard1

#声明这是一个DB(分片副本)集群的配置
shardsvr = true

#设置最大连接数
maxConns=20000
</code></pre><p>分别启动3台机器的shard1 server</p>
<pre><code>启动
mongod -f /data/A/mongodb/conf/shard1.conf

验证端口
[root@bogon ~]# ss -lntup |grep 27001
tcp    LISTEN     0      128    *:27001   *:*   users:((&quot;mongod&quot;,pid=2649,fd=7))

验证日志
[root@bogon ~]# tailf /var/log/mongodb/shard
</code></pre><p>在非仲裁服务器,初始化shard1副本集</p>
<pre><code>连接
mongo --port 27001

使用admin数据库(没有则创建)
use admin

定义副本集配置, 第三个节点的“arbiterOnly”:true 代表其为仲裁节点
&gt; config = {
... _id:&quot;shard1&quot;,
... members: [
...      {_id:0, host:&quot;10.0.10.25:27001&quot;},
...      {_id:1, host:&quot;10.0.10.26:27001&quot;},
...      {_id:2, host:&quot;10.0.10.27:27001&quot;, arbiterOnly:true}
...    ]
... }

初始化副本集配置
&gt; rs.initiate(config);
{ &quot;ok&quot; : 1 }
shard1:SECONDARY&gt; 
</code></pre><p>shard1 Web监控</p>
<pre><code>注: 配置文件中启用了Web监控,如何访问呢？
ss -lntup |grep mongo
tcp    LISTEN     0      128       *:21000    *:*   users:((&quot;mongod&quot;,pid=18173,fd=7))
tcp    LISTEN     0      128       *:27001    *:*   users:((&quot;mongod&quot;,pid=18265,fd=7))
tcp    LISTEN     0      128       *:28001    *:*   users:((&quot;mongod&quot;,pid=18265,fd=9))
可以看到, 端口多出来一个28001

Web访问：
        http://10.0.10.25:28001
        http://10.0.10.26:28001
        http://10.0.10.27:28001

查看shard1副本集状态:
        http://10.0.10.25:28001/_replSet
</code></pre><!-- more -->
<h5 id="设置第二个分片副本集"><a href="#设置第二个分片副本集" class="headerlink" title="设置第二个分片副本集"></a>设置第二个分片副本集</h5><pre><code>vim /data/A/mongodb/conf/shard2.conf
</code></pre><pre><code>pidfilepath = /data/A/mongodb/shard2/shard2.pid
dbpath = /data/A/mongodb/shard2/data
logpath = /var/log/mongodb/shard2/shard2.log
logappend = true

bind_ip = 0.0.0.0
port = 27002
fork = true

#打开web监控
httpinterface=true
rest=true

#副本集名称
replSet=shard2

#声明这是一个DB(分片副本)集群的配置
shardsvr = true

#设置最大连接数
maxConns=20000
</code></pre><p>分别启动3台机器的shard2 server</p>
<pre><code>启动shard2
mongod -f /data/A/mongodb/conf/shard2.conf

端口验证
[root@bogon ~]# ss -lntup |grep mongo
tcp    LISTEN     0      128       *:21000    *:*   users:((&quot;mongod&quot;,pid=2326,fd=7))
tcp    LISTEN     0      128       *:27001    *:*   users:((&quot;mongod&quot;,pid=2649,fd=7))
tcp    LISTEN     0      128       *:27002    *:*   users:((&quot;mongod&quot;,pid=2755,fd=7))
tcp    LISTEN     0      128       *:28001    *:*   users:((&quot;mongod&quot;,pid=2649,fd=9))
tcp    LISTEN     0      128       *:28002    *:*   users:((&quot;mongod&quot;,pid=2755,fd=9))

日志验证
tailf /var/log/mongodb/shard2/shard2.log
</code></pre><p>在非仲裁服务器，初始化shard2副本集</p>
<pre><code>连接
mongo --port 27002

使用admin数据库
use admin

定义副本集配置, 第三个节点的“arbiterOnly”:true 代表其为仲裁节点
&gt; config = {
... _id:&quot;shard2&quot;,
... members: [
...      {_id:0, host:&quot;10.0.10.25:27002&quot;,arbiterOnly:true},
...      {_id:1, host:&quot;10.0.10.26:27002&quot;},
...      {_id:2, host:&quot;10.0.10.27:27002&quot;}
...    ]
... }

初始化副本集配置
&gt; rs.initiate(config);
{ &quot;ok&quot; : 1 }
shard2:SECONDARY&gt; 
</code></pre><p>shard2 Web监控</p>
<pre><code>Web访问：
        http://10.0.10.25:28002
        http://10.0.10.26:28002
        http://10.0.10.27:28002

查看shard2副本集状态:
        http://10.0.10.25:28002/_replSet
</code></pre><!-- more -->
<h5 id="设置第三个分片副本集"><a href="#设置第三个分片副本集" class="headerlink" title="设置第三个分片副本集"></a>设置第三个分片副本集</h5><pre><code>vim /data/A/mongodb/conf/shard3.conf
</code></pre><pre><code>pidfilepath = /data/A/mongodb/shard3/shard3.pid
dbpath = /data/A/mongodb/shard3/data
logpath = /var/log/mongodb/shard3/shard3.log
logappend = true

bind_ip = 0.0.0.0
port = 27003
fork = true

#打开web监控
httpinterface=true
rest=true

#副本集名称
replSet=shard3

#声明这是一个DB(分片副本)集群的配置
shardsvr = true

#设置最大连接数
maxConns=20000
</code></pre><p>分别启动3台机器的shard3 server</p>
<pre><code>启动shard3
mongod -f /data/A/mongodb/conf/shard3.conf

端口验证
[root@bogon ~]# ss -lntup |grep mongo
tcp    LISTEN     0      128       *:21000  *:*   users:((&quot;mongod&quot;,pid=2326,fd=7))
tcp    LISTEN     0      128       *:27001  *:*   users:((&quot;mongod&quot;,pid=2649,fd=7))
tcp    LISTEN     0      128       *:27002  *:*   users:((&quot;mongod&quot;,pid=2755,fd=7))
tcp    LISTEN     0      128       *:27003  *:*   users:((&quot;mongod&quot;,pid=2827,fd=7))
tcp    LISTEN     0      128       *:28001  *:*   users:((&quot;mongod&quot;,pid=2649,fd=9))
tcp    LISTEN     0      128       *:28002  *:*   users:((&quot;mongod&quot;,pid=2755,fd=9))
tcp    LISTEN     0      128       *:28003  *:*   users:((&quot;mongod&quot;,pid=2827,fd=9))

日志验证
tailf /var/log/mongodb/shard3/shard3.log
</code></pre><p>在非仲裁服务器，初始化shard3副本集</p>
<pre><code>连接
mongo --port 27003

使用admin数据库
use admin

定义副本集配置, 第三个节点的“arbiterOnly”:true 代表其为仲裁节点
&gt; config = {
... _id:&quot;shard3&quot;,
... members: [
...      {_id:0, host:&quot;10.0.10.25:27003&quot;},
...      {_id:1, host:&quot;10.0.10.26:27003&quot;,arbiterOnly:true},
...      {_id:2, host:&quot;10.0.10.27:27003&quot;}
...    ]
... }

初始化副本集配置
&gt; rs.initiate(config);
{ &quot;ok&quot; : 1 }
shard3:SECONDARY&gt; 
</code></pre><p>shard3 Web监控</p>
<pre><code>Web访问：
        http://10.0.10.25:28003
        http://10.0.10.26:28003
        http://10.0.10.27:28003

查看shard3副本集状态:
        http://10.0.10.25:28003/_replSet
</code></pre><!-- more -->
<h4 id="配置路由服务-mongos"><a href="#配置路由服务-mongos" class="headerlink" title="配置路由服务 mongos"></a>配置路由服务 mongos</h4><p>先启动配置服务器和分片服务器,后启动路由实例（三台机器）</p>
<pre><code>vim /data/A/mongodb/conf/mongos.conf
</code></pre><pre><code>pidfilepath = /data/A/mongodb/mongos/mongos.pid
logpath = /var/log/mongodb/mongos/mongos.log
logappend = true

bind_ip = 0.0.0.0
port = 20000
fork = true

#监听的配置服务器,只能有1个或者3个 configs为配置服务器的副本集名字
configdb = configs/10.0.10.25:21000,10.0.10.26:21000,10.0.10.27:21000

#设置最大连接数
maxConns=20000
</code></pre><p>启用3台服务器的mongos</p>
<pre><code>启动(启动命令为mongos)
mongos -f /data/A/mongodb/conf/mongos.conf

验证端口
[root@bogon ~]# ss -lntup |grep mongos
tcp    LISTEN     0      128       *:20000   *:*  users:((&quot;mongos&quot;,pid=2933,fd=5))

验证日志
tailf /var/log/mongodb/mongos/mongos.log
</code></pre><!-- more -->
<h4 id="启用分片"><a href="#启用分片" class="headerlink" title="启用分片"></a>启用分片</h4><pre><code>目前已经成功部署了mongodb配置服务器、路由服务器，各个分片服务器，此时当应用程序连接到mongos路由服务器时并不能使用分片机制，还需要在程序里设置分片配置，让分片生效。
</code></pre><p>登陆任意一台mongos</p>
<pre><code>连接mongos
mongo --port 20000

使用admin数据库
use admin

串联路由服务器与分配副本集
sh.addShard(&quot;shard1/10.0.10.25:27001,10.0.10.26:27001,10.0.10.27:27001&quot;)
sh.addShard(&quot;shard2/10.0.10.25:27002,10.0.10.26:27002,10.0.10.27:27002&quot;)
sh.addShard(&quot;shard3/10.0.10.25:27003,10.0.10.26:27003,10.0.10.27:27003&quot;)

查看集群状态
sh.status()
</code></pre><!-- more -->
<h4 id="指定数据库自动分片及测试"><a href="#指定数据库自动分片及测试" class="headerlink" title="指定数据库自动分片及测试"></a>指定数据库自动分片及测试</h4><pre><code>目前配置服务、路由服务、分片服务、副本集服务都已经串联起来了，但我们的目的是希望插入数据，数据能够自动分片。连接在mongos上，准备让指定的数据库、指定的集合分片生效。
</code></pre><pre><code>连接mongos
mongo --port 20000

切换到admin
use admin

#指定testdb分片生效
db.runCommand( { enablesharding :&quot;testdb&quot;});

#指定数据库里需要分片的集合和片键
db.runCommand( { shardcollection : &quot;testdb.table1&quot;,key : {id: 1} } )
</code></pre><pre><code>我们设置testdb的 table1表需要分片，根据 id 自动分片到 shard1 ，shard2，shard3 上面去。要这样设置是因为不是所有mongodb 的数据库和表 都需要分片！
</code></pre><p>报错处理</p>
<pre><code>注:如果不切换到admin则会报错
mongos&gt; db.runCommand({enablesharding:&quot;test&quot;});  
{  
    &quot;ok&quot; : 0,  
    &quot;errmsg&quot; : &quot;enableSharding may only be run against the admin database.&quot;,  
    &quot;code&quot; : 13  
}
</code></pre><p>测试分片配置结果</p>
<pre><code>连接任意一个mongos
mongo  mongo 10.0.10.25:20000

使用testdb
use  testdb;

插入测试数据
mongos&gt; db.table1.insert({id:1,&quot;test1&quot;:&quot;testval1&quot;});
mongos&gt; db.table1.insert({id:2,&quot;test1&quot;:&quot;testval1&quot;});
mongos&gt; db.table1.insert({id:4,&quot;test1&quot;:&quot;testval1&quot;});
WriteResult({ &quot;nInserted&quot; : 1 })
</code></pre><p>查看分片情况如下，部分无关信息省掉了</p>
<pre><code>db.table1.stats();

{
        &quot;sharded&quot; : true,
        &quot;ns&quot; : &quot;testdb.table1&quot;,
        &quot;count&quot; : 100000,
        &quot;numExtents&quot; : 13,
        &quot;size&quot; : 5600000,
        &quot;storageSize&quot; : 22372352,
        &quot;totalIndexSize&quot; : 6213760,
        &quot;indexSizes&quot; : {
                &quot;_id_&quot; : 3335808,
                &quot;id_1&quot; : 2877952
        },
        &quot;avgObjSize&quot; : 56,
        &quot;nindexes&quot; : 2,
        &quot;nchunks&quot; : 3,
        &quot;shards&quot; : {
                &quot;shard1&quot; : {
                        &quot;ns&quot; : &quot;testdb.table1&quot;,
                        &quot;count&quot; : 42183,
                        &quot;size&quot; : 0,
                        ...
                        &quot;ok&quot; : 1
                },
                &quot;shard2&quot; : {
                        &quot;ns&quot; : &quot;testdb.table1&quot;,
                        &quot;count&quot; : 38937,
                        &quot;size&quot; : 2180472,
                        ...
                        &quot;ok&quot; : 1
                },
                &quot;shard3&quot; : {
                        &quot;ns&quot; : &quot;testdb.table1&quot;,
                        &quot;count&quot; :18880,
                        &quot;size&quot; : 3419528,
                        ...
                        &quot;ok&quot; : 1
                }
        },
        &quot;ok&quot; : 1
}
</code></pre><h4 id="后期运维"><a href="#后期运维" class="headerlink" title="后期运维"></a>后期运维</h4><pre><code>mongodb的启动顺序:  (先启动)配置服务器 --&gt;再启动分片 --&gt; 最后启动mongos.

mongod -f /data/A/mongodb/conf/config.conf
mongod -f /data/A/mongodb/conf/shard1.conf
mongod -f /data/A/mongodb/conf/shard2.conf
mongod -f /data/A/mongodb/conf/shard3.conf
mongos -f /data/A/mongodb/conf/mongos.conf

建议使用supervisor管理启动mongodb
</code></pre><p>参考：<a href="http://www.ityouknow.com/mongodb/2017/08/05/mongodb-cluster-setup.html" target="_blank" rel="noopener">mongodb3.4集群部署</a></p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2018-02-23T03:08:57.370Z" itemprop="dateUpdated">2018-02-23 11:08:57</time>
</span><br>


        
        转载文章请注明出处！  <br>文章永久链接：<a href="/2018/02/22/高可用MongoDB集群/" target="_blank" rel="external">https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/</a><br><br>欢迎加入"运维中国"-Telegram讨论组：<a target="_blank" rel="external">https://t.me/om_china</a>
        
    </div>
    
    <footer>
        <a href="https://wuyanteng.github.io">
            <img src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/touxiang.jpg" alt="Gary Wu">
            Gary Wu
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mongo/">Mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分片/">分片</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/副本集/">副本集</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/路由/">路由</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/高可用/">高可用</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/高级运维/">高级运维</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/&title=《高可用MongoDB集群》 — Gary Wu&pic=https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/touxiang.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/&title=《高可用MongoDB集群》 — Gary Wu&source=MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《高可用MongoDB集群》 — Gary Wu&url=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/&via=https://wuyanteng.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/02/23/MongoDB之数据库管理/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">MongoDB之数据库管理</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/02/16/gentoo-rc-update启动项管理/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">gentoo rc-update启动项管理</h4>
      </a>
    </div>
  
</nav>



    














</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们不一样
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/%E5%BE%AE%E4%BF%A1%E6%94%B6%E6%AC%BE.png" alt="打赏二维码">
        </div>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>很惭愧，在运维不归路上，一去不复返。。。始终不忘初心！我是GaryWu</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Gary Wu &copy; 2015 - 2018</span>
            <span>
                
                <a href="https://wuyanteng.github.io" target="_blank">博客由Hexo强力驱动</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/&title=《高可用MongoDB集群》 — Gary Wu&pic=https://raw.githubusercontent.com/wuyanteng/wuyanteng.github.io/master/images/touxiang.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/&title=《高可用MongoDB集群》 — Gary Wu&source=MongoDB是最易用的NoSQL，比较适合取代MySQL做一些存储，不过不是强一致性的。本章节主要分享高可用分片+副本集部署。从下图中可以看到有四个组件..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《高可用MongoDB集群》 — Gary Wu&url=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/&via=https://wuyanteng.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://wuyanteng.github.io/2018/02/22/高可用MongoDB集群/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACM0lEQVR42u3a0U7EMAxE0f7/T5dXEKw1M26R7Nw8oaWb5BTJOHauSx73t1F//umT37+tx/XGgAEDxliGMl0N0DH163DZMGDAOI3xKYIpU2fBVA/f9d5gwIABo16yztPcUKusCwMGDBjKVrJkUQHDgAEDRs3IDqX90ps+w2NncRgwYAxk6FX3///5lf4GDBgwRjFuc7jtTCW9ywp2P74LAwaM1YyshVknZ+61jOySxx8zwIABYylD39B7R9NOwQ4GDBgnMNwp3ORPeR36zFLQhwEDxlKG/mh2/cLd7isVQRgwYIxluCFVP4jq6WC/DAcDBozdjE6TMjvuZisaFyxgwICxjuGmenrYVcKlVD4T9gMDBozdjGy7WYLopnruERoGDBi7GU9lWVnClxXvYMCAcQ4jC5T9+ryLsZNCGDBgHMDQS/bZ81mANlqYMGDAWMTIgqB786FDDfNcGDBgrGMoYfQWhvI69O/a6SYMGDBWM9zA516hyEppSiHP+JvAgAFjOEO/VOo+7wbTThMCBgwYJzDcSxVuGNXbD2GLAgYMGKsZ2cJuG7JO77JmQ9j3gAEDxijGbY5OKT9LAaUgCwMGjNWMrNGol/WVMlnnKkbrEgYMGDBGMdwgq2zLxYQ5rPumYcCAMZzhNiP1o6kblMOzOAwYMGAIB9csBczaCY8FXBgwYCxluJe6lETzgXIeDBgwDmC4U2cLK4X+8B8ADBgwVjM6tSw9NCsBVweETU0YMGDMY3wB9x+3PReTujQAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" async></script>




<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '经检测,你已离开...';
            clearTimeout(titleTime);
        } else {
            document.title = '欢迎回来...';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
